\title{
Decoding Stock Market with Quant Alphas
}



\begin{abstract}
We give an explicit algorithm and source code for extracting expected returns for stocks from expected returns for alphas. Our algorithm altogether bypasses combining alphas with weights into "alpha combos". Simply put, we have developed a new method for trading alphas which does not involve combining them. This yields substantial cost savings as alpha combos cost hedge funds around $3 \%$ of the $\mathrm{P} \& \mathrm{~L}$, while alphas themselves cost around $10 \%$. Also, the extra layer of alpha combos, which our new method avoids, adds noise and suboptimality. We also arrive at our algorithm independently by explicitly constructing alpha risk models based on position data. ${ }^{4}$ Forecasting stock returns with quant alphas has implications for the investment industry.
\end{abstract}

\section*{1 Introduction and Summary}

Not long ago quant trading workshops featured "man v. machine" debates. Well, it is a foregone conclusion. Quantitative alpha ${ }^{5}$ mining is now done by machines. Human's role in this process has essentially shifted to coding up various machine learning, data mining, clustering and other similar algorithms. Hardware is cheap, so mining millions of alphas is no longer a dream but the reality. Unsurprisingly, these exponentially proliferating alphas are ever fainter and more ephemeral.

A typical such alpha cannot even be traded on its own - its signal is too weak to make any money after trading costs. ${ }^{6}$ So, quant traders follow an ancient "there is strength in numbers" wisdom and combine a large number of these faint alphas into a single "mega-alpha" with some nontrivial weights. The game then becomes how to pick these weights optimally. This is essentially an alpha portfolio optimization problem. And it is a nontrivial one. Ostensibly, it is similar to a stock portfolio optimization problem [Markowitz, 1952], [Sharpe, 1994]. However, there is an important detail that makes all the difference: the number of alphas can be huge, in hundreds of thousands, millions or even billions. The available history (lookback), however, naturally is much shorter, ${ }^{7}$ precisely due to the ephemerality of these alphas. ${ }^{8}$

There are various ways of approaching this problem of combining a large number of alphas. If the only available information is the time series of alpha returns, then the playing field is limited. As discussed in [Kakushadze and Yu, 2017a], modeling the alpha portfolio risk via a statistical risk model ${ }^{9}$ based solely on this time series or its extension via adding a few "style" risk factors ${ }^{10}$ at the end of the day invariably leads to a simple answer that the alpha weights are ${ }^{11}$ proportional to residuals of a (weighted) regression. Simply put, it is the size of the available data (in this case, the lookback) that determines how much of the alpha risk space we can cover.

So, to hedge more directions in the risk space, we need more data. And such data is available [Kakushadze, 2014]: the position data of the underlying tradable instruments; e.g., if our alpha is a dollar-neutral portfolio of, say, 2,000 most liquid US stocks, a time series of the positions that this alpha instructs us to take. The question is, how can we use this position data? E.g., can we improve alpha weights?

\footnotetext{
${ }^{5}$ Here "alpha" - following the common trader lingo - generally means any reasonable "expected return" that one may wish to trade on and is not necessarily the same as the "academic" alpha. In practice, often the detailed information about how alphas are constructed may not even be available, e.g., the only data available could be the position data, so "alpha" then is a set of instructions to achieve certain stock (or some other instrument) holdings by some times $t_{1}, t_{2}, \ldots$
${ }^{6}$ This includes transaction costs (exchange, broker-dealer, SEC, etc., fees) as well as slippage.
${ }^{7}$ E.g., with daily observations, there are $T \sim 250$ datapoints in a (generous) 1 year lookback.
${ }^{8}$ Additional considerations such as optimizing the turnover of the "mega-alpha", trading which (as opposed to the individual alphas) offers an automatic benefit of internal crossing of trades (i.e., trading cost reduction), and scalability (i.e., how much capital this "mega-alpha" can absorb before its market impact results in diminishing returns) add further complexity to the problem.
${ }^{9}$ For a recent discussion of statistical risk models, see [Kakushadze and Yu, 2017b].
${ }^{10}$ E.g., turnover, etc. See [Kakushadze, 2014] and [Kakushadze and Yu, 2017a] for details.
11 Up to corrections suppressed by powers of $1 / N$, where $N$ is the number of alphas.
}

One idea set forth in [Kakushadze, 2014] (and further discussed in [Kakushadze and $\mathrm{Yu}, 2017 \mathrm{a}]$ ) is to use the position data for the underlying tradable instruments to build risk models for alpha portfolios - albeit without an explicit implementation. In this paper we fill this gap - although the result is not what one would expect based on the intuition from risk modeling for stocks - and discuss alpha risk models in detail. We do this to give an alternative - and compelling - way of arriving at our main result, which we first set forth without any reference to alpha portfolio risk.

Our idea is simple. We have a large number $N$ of alphas - say, $N=1,000,000$. Let us assume that these alphas are all trading the same underlying $M$ instruments - say, $M=3,000$ most liquid US stocks. ${ }^{12}$ To determine the weights with which individual alphas contribute to the "mega-alpha" (i.e., the alpha portfolio), we need expected returns for individual alphas. Then we can ask the following question:

Can we forecast expected returns for the underlying tradables (stocks) using the expected returns for alphas? Put differently, can we decode the stock market using alphas? The answer is affirmative. And this is where the position data comes in.

Now, if we can forecast stock expected returns using alpha expected returns, then we no longer need to combine alphas. We can trade a stock portfolio directly based on stock expected returns. And we can do all the risk management directly on this stock portfolio as opposed to doing it in two steps, by first managing the alpha portfolio risk, and then managing the risk of the stock portfolio corresponding to the "mega-alpha". I.e., we will not need the extra step of constructing the alpha portfolio - and intuitively it is clear that a priori this extra layer could be a source of additional noise and suboptimality. So, we should just get rid of it if we can. ${ }^{13}$

In Section 2 we give an explicit algorithm for extracting stock expected returns from alpha expected returns. We give the source code for this algorithm in Appendix A. ${ }^{14}$ The stock expected returns are nothing but coefficients in a weighted regression of alpha expected returns over the position data. Subtleties arise when the individual alpha portfolios are subject to linear constraints, e.g., dollar neutrality or sector/(sub-)industry neutrality, and we discuss how to deal with them. We also discuss how to choose the regression weights (other than inverse alpha variances).

In Section 3 we give an explicit algorithm for building risk models for alpha portfolios using the position data for the underlying tradables. The source code therefor is subsumed in Appendix A. Following [Kakushadze and Yu, 2017a], we then show that, when $N \gg 1$, optimization using this risk model reduces to the weighted regression in Section 2. A neat subtlety is that in the "leading" order in the powers of $1 / N$ the stock expected returns vanish, and it is the "next-to-leading" order that reproduces the results of Section 2. We briefly conclude in Section 4.

\footnotetext{
${ }^{12}$ Each alpha may have its own universe of stocks. What is important here is that their universes have a substantial overlap. If they do not, we can always exclude the alphas with small overlap.
${ }^{13}$ Thereby turning an underconstrained $T \ll N$ problem into a much easier $N \gg M$ problem.
${ }^{14}$ The source code given in Appendix A hereof is not written to be "fancy" or optimized for speed or in any other way. Its sole purpose is to illustrate the algorithms described in the main text in a simple-to-understand fashion. Some important legalese is relegated to Appendix B.
}

\section*{2 Stock Returns from Alphas}

For definiteness - and the underlying instruments are not critical here - let us focus on alphas that trade (largely) overlapping portfolios of US stocks. Let the number of all stocks traded be $M$, and let the number of alphas be $N \gg M$. Let the realized returns for alphas be $\rho_{i s}(i=1, \ldots, N)$, and the realized returns for stocks be $R_{A s}$ $(A=1, \ldots, M)$, where the index $s=1, \ldots, T$ labels trading days (for definiteness, let $s=1$ correspond to the most recent date). Then we have
$$
\begin{equation*}
\rho_{i s}=\sum_{A=1}^{M} P_{i A s} R_{A s} \tag{1}
\end{equation*}
$$

Here on each day labeled by $s$ for each alpha labeled by $i$ the quantities $P_{i A s}$ are nothing but the properly normalized stock positions in the corresponding alpha portfolio. The normalization condition is given by
$$
\begin{equation*}
\sum_{A=1}^{M}\left|P_{i A s}\right|=1 \tag{2}
\end{equation*}
$$

The stock positions $P_{i A s}$, a.k.a. the desired holdings, are "previsible", i.e., they are known in advance of commencing the trading that is supposed to achieve these positions. Under the hood, alphas analyze historical and real-time data up to the time these positions are calculated. Another way of phrasing this is that the positions $P_{i A s}$ are known out-of-sample. This has implications for stock expected returns.

\subsection*{2.1 How to Extract Stock Expected Returns?}

Above we discussed the relation (1) between the realized returns for stocks $R_{A s}$ and the realized returns for alphas $\rho_{i s}$. These are ex-post returns. These returns are not known in advance of commencing the trading that is supposed to achieve the positions $P_{i A s}$. What is known ex-ante, i.e., what is forecast based on the historical data, are expected returns for alphas, call them $\eta_{i s}$. These expected returns are also "previsible" (or out-of-sample) by construction. E.g., a simple way to construct them is via moving averages based on prior $d$ days' worth of realized returns: ${ }^{15}$
$$
\begin{equation*}
\eta_{i s}=\frac{1}{d} \sum_{s^{\prime}=s+1}^{s+d} \rho_{i s^{\prime}} \tag{3}
\end{equation*}
$$
\footnotetext{
${ }^{15}$ We emphasize that this is only an example and there are other ways of constructing $\eta_{i s}$.
}

In this example - and this is a reasonable approach - the bet is that, if an alpha on average has made money for the past $d$ days (say, $d=10$ ), then we expect (i.e., hope) that it should (on average) continue to make money moving forward, at least for the foreseeable future (and this expectation, as discussed above, is ephemeral). This is an example of a "momentum" strategy (in this case for alphas, not stocks).

So, suppose, one way or another, we have computed our alpha expected returns $\eta_{i s}$. Can we use them to reasonably define - call them $E_{A s}$ - expected returns for stocks? Sure we can, via a linear model:
$$
\begin{equation*}
\eta_{i s}=\epsilon_{i s}+\sum_{A=1}^{M} P_{i A s} E_{A s} \tag{4}
\end{equation*}
$$
I.e., we mimic (1), except that here, for each date $s$, we have $N$ datapoints $\eta_{i s}$ and many fewer $M$ unknowns $E_{A s}$. The fit (4) via a linear model has errors $\epsilon_{i s}$. And a standard way to fix $E_{A s}$ is by minimizing the least squares of these errors (for each value of $s):{ }^{16}$
$$
\begin{equation*}
\sum_{i=1}^{N} \epsilon_{i s}^{2} \rightarrow \min \tag{5}
\end{equation*}
$$

This is the same as running - for each value of $s$ - a linear cross-sectional (i.e., across the index $i$ ) regression of $\eta_{i s}$ over the $N \times M$ loadings matrix $P_{i A s}$ (without the intercept and with unit weights - see below). Then $\epsilon_{i s}$ are the residuals of this regression, whereas $E_{A s}$ are the regression coefficients given by
$$
\begin{equation*}
E_{A s}=\sum_{i=1}^{N} \sum_{B=1}^{M} Y_{A B s} P_{i B s} \eta_{i s} \tag{6}
\end{equation*}
$$
where for each value of $s$ the $M \times M$ matrix $Y_{A B s}$ is the inverse of the $M \times M$ matrix
$$
\begin{equation*}
X_{A B s}=\sum_{i=1}^{N} P_{i A s} P_{i B s} \tag{7}
\end{equation*}
$$

So, assuming this matrix is invertible, we can calculate the expected returns for stocks $E_{A s}$ using the expected returns for alphas $\eta_{i s}$. The invertibility assumption may not necessarily hold and we discuss how to deal with this below in detail.

\subsection*{2.1.1 Stock Portfolio}

However, let us for now assume the invertibility of $X_{A B s}$. Then, as advertised above, we have extracted the expected returns for stocks $E_{A s}$ and we can directly construct a stock portfolio we wish to trade without any reference to a "mega-alpha", alpha weights, alpha combos, or alpha portfolios. Thus, if we have a good risk model for our stock portfolio, i.e., a positive-definite (and thus invertible) and reasonably stable $M \times M$ risk model covariance matrix $\Phi_{A B}$ for stocks, ${ }^{17}$, then, now that we

\footnotetext{
${ }^{16}$ Here - again, for each value of $s$ - the minimization is w.r.t. the $M$-vector $E_{A s}$.
${ }^{17}$ We discuss how to construct this risk model below.
}
have the stock expected returns $E_{A s}$, we can construct our stock portfolio weights $w_{A s}$ via, e.g., maximizing its Sharpe ratio [Sharpe, 1994]: ${ }^{18}$

$$
\begin{equation*}
w_{A s}=\gamma \sum_{B=1}^{M} \Phi_{A B}^{-1} E_{A s} \tag{8}
\end{equation*}
$$
where the overall normalization coefficient $\gamma$ is fixed via the normalization condition
$$
\begin{equation*}
\sum_{A=1}^{M}\left|w_{A s}\right|=1 \tag{9}
\end{equation*}
$$

\footnotetext{
${ }^{18}$ Here $\Phi_{A B}^{-1}$ is the matrix inverse to $\Phi_{A B}$. More generally, we can have a different covariance matrix $\Phi_{A B s}$ for each date $s$ in (8) - albeit this can increase noise. This is not critical here.
}

We can further add bells and whistles to our stock portfolio optimization, such as position and liquidity bounds on the stock weights $w_{A s}$, dollar-neutrality and other linear constraints, as well as any other standard risk management conditions (which we will not delve into it here). The key is fixing the stock expected returns $E_{A s}$.

\subsection*{2.1.2 Weighted Regression}

Speaking of which, above we fixed them by minimizing the least squares (5). While this is a reasonable approach, it may not be optimal. The reason why is that the realized alpha returns $\rho_{i s}$ and thereby expected alpha returns $\eta_{i s}$ have cross-sectionally skewed historical volatilities [Kakushadze \& Tulchinsky, 2016], [Kakushadze, 2016b]. This then invariably implies that the residuals $\epsilon_{i s}$ also have cross-sectionally skewed historical volatilities. So, (5) receives oversized contributions from volatile alphas. This can be rectified by running least-squares on appropriately normalized errors:
$$
\begin{equation*}
\sum_{i=1}^{N} \widetilde{\epsilon}_{i s}^{2}=\sum_{i=1}^{N} v_{i s} \epsilon_{i s}^{2} \rightarrow \min \tag{10}
\end{equation*}
$$

Here $\widetilde{\epsilon}_{i s}=\epsilon_{i s} / \xi_{i s}$ and $v_{i s}=1 / \xi_{i s}^{2}$. The normalizations $\xi_{i s}$ should be chosen such that they take care of the aforementioned skewness. The simplest choice is to use historical alpha volatilities $\xi_{i s}=\sigma_{i s}$, where $\sigma_{i s}$ can be computed, e.g., based on prior $d$ days' worth of historical data $(\operatorname{Var}(\cdot, d)$ is a $d$-day moving serial variance):
$$
\begin{align*}
& \sigma_{i s}^{2}=\operatorname{Var}\left(\eta_{i s}, d\right)=\frac{1}{d-1} \sum_{s^{\prime}=s+1}^{s+d}\left(\eta_{i s^{\prime}}-\bar{\eta}_{i s}\right)^{2}  \tag{11}\\
& \bar{\eta}_{i s}=\frac{1}{d} \sum_{s^{\prime}=s+1}^{s+d} \eta_{i s^{\prime}} \tag{12}
\end{align*}
$$

Here two questions arise naturally. First, should we compute $\sigma_{i s}^{2}$ based on the expected returns $\eta_{i s}$ or the realized returns $\rho_{i s}$ ? Second, should we set $\xi_{i s}=\sigma_{i s}$ or should we compute $\xi_{i s}$ some other way, e.g., as volatilities of the residuals rather than of the (expected or realized) returns for alphas? We will come back to this below. For now let us simply assume that we have some way of computing $\xi_{i s}$.

Then (10) is equivalent (for each value of $s$ ) to running a weighted regression (without the intercept) of $\eta_{i s}$ over the loadings matrix $P_{i A s}$ with the weights $v_{i s}$. The stock expected returns $E_{A s}$ are the regression coefficients given by
$$
\begin{equation*}
E_{A s}=\sum_{i=1}^{N} \sum_{B=1}^{M} Y_{A B s} v_{i s} P_{i B s} \eta_{i s} \tag{13}
\end{equation*}
$$
where for each value of $s$ the $M \times M$ matrix $Y_{A B s}$ is the inverse of the $M \times M$ matrix
$$
\begin{equation*}
X_{A B s}=\sum_{i=1}^{N} v_{i s} P_{i A s} P_{i B s} \tag{14}
\end{equation*}
$$

As above, invertibility of $X_{A B s}$ is not given. But first we discuss regression weights.

\subsection*{2.1.3 Regression Weights}

So, what should the regression weights be? Since these weights are meant to normalize the regression residuals in (10), it is natural to set $\xi_{i s}^{2}$ to moving serial variances of the time series of the regression residuals $\epsilon_{i s}$. However, let us first discuss why using historical alpha volatilities, which would be a simple choice, may be suboptimal.

Let us first look at historical volatilities of the realized alpha returns (1). When computing serial variances, we would be muddling up non-factorized contributions from the realized stock returns $R_{A s}$ and the fact that the desired holdings $P_{i A s}$ also change from one date $s$ to another. However, this position data is "previsible", it is fixed by how the alphas are constructed, and should not contribute into the measure of uncertainty (i.e., volatility) we use to normalize the regression residuals. On the other hand, the realized alpha returns know nothing about the uncertainty stemming from forecasting the alphas, which is encoded in the time series of the expected alpha return (4). So, using $\eta_{i s}$ is more reasonable, but we still must not muddle up the weights based on $\eta_{i s}$ with the $s$-dependence of the desired holdings $P_{i A s}$. And this is achieved precisely by regressing $\eta_{i s}$ over $P_{i A s}$ (for each date $s$ ), which produces the regression residuals $\epsilon_{i s}$, and setting
$$
\begin{equation*}
\xi_{i s}^{2}=\operatorname{Var}\left(\epsilon_{i s}, d\right) \tag{15}
\end{equation*}
$$
$\operatorname{Var}(\cdot, d)$ is defined in (11). So, the regression with unit weights fixes $v_{i s}=1 / \xi_{i s}^{2}$.

\subsection*{2.2 Linear Constraints}

There may be additional linear constraints on stock positions stemming from all alphas being subject to the same risk management restrictions. E.g., suppose all alphas are dollar-neutral. Then we have:
$$
\begin{equation*}
\sum_{A=1}^{M} P_{i A s} \equiv 0 \tag{16}
\end{equation*}
$$

More generally, we can have $p$ linear constraints (typically, $p \ll M$, so we assume that this holds)
$$
\begin{equation*}
\sum_{A=1}^{M} P_{i A s} Q_{A \alpha} \equiv 0, \quad \alpha=1, \ldots, p \tag{17}
\end{equation*}
$$

Without loss of generality we can assume that: i) the $p$ columns of the matrix $Q_{A \alpha}$ are linearly independent; ${ }^{19}$ and ii) the constraints (17) do not imply that $P_{i A s} \equiv 0$ for any given value of $A$ (or else none of the alphas trade the stock labeled by $A$ and we can simply drop it out of the universe). Furthermore, to keep it simple, we will assume that if there is a subset of $N_{1}$ alphas $\left(N_{1}<N\right)$ for which - but not for all alphas - we have additional linear constraints other than (17), then $N_{1} \ll N$.

\footnotetext{
${ }^{19}$ The constraints (17) are invariant under $S O(p)$ rotations $Q \rightarrow Q U$, where $U_{\alpha \beta}$ is an orthogonal matrix: $U U^{T}=U^{T} U=1$.
}

If we have $p>0$ linear constraints, our alphas do not depend on $p$ linear combinations of the stock returns. We can decompose
$$
\begin{align*}
& R_{A s}=R_{A s}^{\prime}+\sum_{\alpha=1}^{p} Q_{A \alpha} R_{\alpha s}  \tag{18}\\
& \sum_{A=1}^{M} Q_{A \alpha} R_{A s}^{\prime} \equiv 0 \tag{19}
\end{align*}
$$
where
$$
\begin{equation*}
R_{\alpha s}=\sum_{A=1}^{M} \widetilde{Q}_{\alpha A} R_{A s} \tag{20}
\end{equation*}
$$
and (in matrix notations) $\widetilde{Q}=\left(Q^{T} Q\right)^{-1} Q^{T}$. Note that the matrix $Q^{T} Q$ is nonsingular as the columns of $Q_{A \alpha}$ are linearly independent. So, the alpha returns
$$
\begin{equation*}
\rho_{i s}=\sum_{A=1}^{M} P_{i A s} R_{A s}^{\prime} \tag{21}
\end{equation*}
$$
know nothing about the returns $R_{\alpha s}$ for the risk factors defined by the factor loadings matrix $Q_{A \alpha}$. E.g., in the case of a single dollar-neutrality constraint (16) we have $Q_{A \alpha} \equiv 1(\alpha=1)$, and the corresponding return $R_{\alpha s}=\frac{1}{M} \sum_{A=1}^{M} R_{A s}$ is nothing but the average stock portfolio return, which for large $M$ can be thought of as an equally-weighted broad-market return. Dollar neutrality hedges against market risk.

Based on the foregoing, intuitively it is clear that in the presence of linear constraints (17) we cannot forecast all stock expected returns using alpha expected returns, but only $M-p$ linear combinations thereof as the alpha portfolios are neutral under the remaining $p$ linear combinations. So, we need to reduce the number of stock returns from $M$ to $M-p$. There are various ways of achieving this goal.

\subsection*{2.3 Elimination Method}

Thus, we can build a portfolio of $M-p$ stocks as follows. At each step $r \leq M$ we have three sets $\Pi_{r}, \widetilde{\Pi}_{r}$ and $\Upsilon_{r}$. At step $r=1$ we start with $\Pi_{1}=\{A \mid A=1\}$, $\widetilde{\Pi}_{1}=\{A \mid A=2,3, \ldots, M\}$, and $\Upsilon_{1}=\{\alpha \mid \alpha=1, \ldots, p\}$. At each step $r$, where $r<M$, we define $\Pi_{r}^{\prime}=\Pi_{r} \cup\{B\}$, where $B=\min \left(\widetilde{\Pi}_{r}\right)$. If there is no $\beta \in \Upsilon_{r}$ such that
$$
\begin{equation*}
\sum_{A \in \Pi_{r}^{\prime}} P_{i A s} Q_{A \beta} \equiv 0 \tag{22}
\end{equation*}
$$
then we define $\Pi_{r+1}=\Pi_{r}^{\prime}$ (i.e., we add $B$ to $\Pi_{r}$ ), $\widetilde{\Pi}_{r+1}=\widetilde{\Pi}_{r} \backslash\{B\}$ (i.e., we delete $B$ from $\widetilde{\Pi}_{r}$ ) and $\Upsilon_{r+1}=\Upsilon_{r}$. If such $\beta$ does exist, then we define $\Pi_{r+1}=\Pi_{r}$, $\widetilde{\Pi}_{r+1}=\widetilde{\Pi}_{r} \backslash\{B\}$ and $\Upsilon_{r+1}=\Upsilon_{r} \backslash\{\beta\}$ (i.e., we delete $\beta$ from $\Upsilon_{r}$ ). At step $r=M$ we end up with the subset $\Pi_{M} \subset\{1, \ldots, M\}$ such that there are no linear constraints on $P_{i A s}$ for $A \in \Pi_{M}$. The subset $J=\Pi_{M}$ has $|J|=M-p$ elements. Its complement $\widetilde{J}=\{1, \ldots, M\} \backslash J$ has $|\widetilde{J}|=p$ elements. Moving forward we will use the lower case characters $a, b, \ldots$ (from the beginning of the Latin alphabet) to label the stocks corresponding to the subset $J$, and the characters $\mu, \nu, \ldots$ (from the middle of the Greek alphabet) ${ }^{20}$ to label the stocks corresponding to the subset $\widetilde{J}$. Then we can rewrite (19) via
$$
\begin{equation*}
\sum_{\mu \in \tilde{J}} q_{\mu \alpha} R_{\mu s}^{\prime}=-\sum_{a \in J} K_{a \alpha} R_{a s}^{\prime} \tag{23}
\end{equation*}
$$
where (in matrix notations) $q_{\mu \alpha}=Q_{\mu \alpha}$ and $K_{a \alpha}=Q_{a \alpha}$. Therefore, we have
$$
\begin{align*}
& R_{\mu s}^{\prime}=-\sum_{a \in J} \chi_{\mu a} R_{a s}^{\prime}  \tag{24}\\
& \rho_{i s}=\sum_{a \in J} S_{i a s} R_{a s}^{\prime} \tag{25}
\end{align*}
$$
where (in matrix notations) $\chi=\left(q q^{T}\right)^{-1} q K^{T}$ and
$$
\begin{equation*}
S_{i a s}=P_{i a s}-\sum_{\mu \in \widetilde{J}} P_{i \mu s} \chi_{\mu a} \tag{26}
\end{equation*}
$$

\footnotetext{
${ }^{20}$ Not to be confused with the characters $\alpha, \beta, \ldots$ from the beginning of the Greek alphabet we use in $Q_{A \alpha}$.
}

So, (25) now looks like there are no linear constraints, except that the stock universe is smaller ( $M-p$ stocks instead of $M$ ), the stock "positions" are now given by $S_{i a s}$ (instead of $P_{i A s}$ ), and the $M-p$ returns are $R_{a s}^{\prime}$. The remaining $p$ returns $R_{\mu s}^{\prime}$ are fixed via (24), and the $M$ returns $R_{A s}^{\prime}$ are not the same as the original returns $R_{A s}$ but are projected onto an $(M-p)$-dimensional hyperplane via (19). The directions $R_{\alpha s}$ perpendicular to this hyperplane are unattainable, but we can solve for $R_{A s}^{\prime}$.

\subsection*{2.4 Principal Components}

There is a formally simpler method for dealing with linear constraints. The practical issue is that (for each value of $s$ ) the $M \times M$ matrix (14) is singular in the presence of linear constraints (17). This can be dealt with as follows. Let us decompose the matrix $X_{A B s}$ using its principal components $V_{A s}^{(C)}$ :
$$
\begin{equation*}
X_{A B s}=\sum_{C=1}^{M} \lambda_{s}^{(C)} V_{A s}^{(C)} V_{B s}^{(C)} \tag{27}
\end{equation*}
$$

Let us label the positive eigenvalues via $\lambda_{s}^{(a)}, a \in J,|J|=M-p$, and the null eigenvalues via $\lambda_{s}^{(\mu)}, \mu \in \widetilde{J},|\widetilde{J}|=p$. We can regularize the matrix $X_{A B s}$ via
$$
\begin{equation*}
X_{A B s}=\sum_{a \in J} \lambda_{s}^{(a)} V_{A s}^{(a)} V_{B s}^{(a)}+\sum_{\mu \in \tilde{J}} \lambda_{0} V_{A s}^{(\mu)} V_{B s}^{(\mu)} \tag{28}
\end{equation*}
$$
where at the end of the day we will take $\lambda_{0} \rightarrow 0+$. Note that, by definition, we have
$$
\begin{align*}
& \sum_{A=1}^{M} V_{A s}^{(a)} Q_{A \alpha} \equiv 0  \tag{29}\\
& \sum_{A=1}^{M} V_{A s}^{(\mu)} P_{i A s} \equiv 0 \tag{30}
\end{align*}
$$

The inverse of $X_{A B s}$ is given by
$$
\begin{equation*}
Y_{A B s}=\sum_{a \in J}\left[\lambda_{s}^{(a)}\right]^{-1} V_{A s}^{(a)} V_{B s}^{(a)}+\sum_{\mu \in \tilde{J}} \lambda_{0}^{-1} V_{A s}^{(\mu)} V_{B s}^{(\mu)} \tag{31}
\end{equation*}
$$

Plugging this into (13), we get
$$
\begin{equation*}
E_{A s}=\sum_{i=1}^{N} \sum_{B=1}^{M} \sum_{a \in J}\left[\lambda_{s}^{(a)}\right]^{-1} V_{A s}^{(a)} V_{B s}^{(a)} v_{i s} P_{i B s} \eta_{i s} \tag{32}
\end{equation*}
$$

This expression is independent of the regulator $\lambda_{0}$, which we can safely take to 0 . Note that
$$
\begin{equation*}
\sum_{A=1}^{M} E_{A s} Q_{A \alpha} \equiv 0 \tag{33}
\end{equation*}
$$

Once again, only the directions orthogonal to the linear constraints are attainable.

\section*{3 Alpha Risk Models}

The formulas (32), (8) and (9) express the stock portfolio weights via alpha expected returns, without any reference to alpha portfolio weights. We will now derive this result in a seemingly unrelated way, by constructing risk models for alpha portfolios.

So, as it is normally done in practice, let us combine our $N$ alphas with some weights $w_{i s}$, which we need to fix somehow. Let us look at the risk of the underlying stock portfolio corresponding to these alpha weights. The corresponding stock weights are given by
$$
\begin{equation*}
w_{A s}=\sum_{i=1}^{N} P_{i A s} w_{i s} \tag{34}
\end{equation*}
$$

On a given date $s$, the (expected) stock portfolio variance is given by
$$
\begin{align*}
& \sum_{A, B=1}^{M} \Phi_{A B} w_{A s} w_{B s}=\sum_{i, j=1}^{N} w_{i s} w_{j s} F_{i j s}  \tag{35}\\
& F_{i j s}=\sum_{A, B=1}^{M} P_{i A s} \Phi_{A B} P_{j B s} \tag{36}
\end{align*}
$$
where, as above, $\Phi_{A B}$ is a positive-definite (and reasonably stable) $M \times M$ risk model covariance matrix for stocks. ${ }^{21}$ Even though $\Phi_{A B}$ is invertible, the $N \times N$ matrix $F_{i j s}$ (for each value of $s$ ) is singular - there are many more alphas than stocks. In fact, the l.h.s. is nothing but an incomplete factor model with $M$ factors, the factor loadings matrix $P_{i A s}$, and the factor covariance matrix $\Phi_{A B}$. What is missing is the specific (a.k.a. idiosyncratic) risk on the diagonal. Once we add the specific risk, call it $\zeta_{i s}^{2}$, we have an $M$-factor model with a positive-definite model covariance matrix for our $N$ alphas: ${ }^{22}$
$$
\begin{equation*}
\Gamma_{i j s}=\zeta_{i s}^{2} \delta_{i j}+F_{i j s} \tag{37}
\end{equation*}
$$

\footnotetext{
${ }^{21}$ The comment in footnote 18 applies to (36) as well.
${ }^{22}$ We can think about the specific risk in the matrix $\Gamma_{i j s}$ in (37) as modeling the uncertainty in the alpha expected returns other than that due to stock volatility. The latter is modeled by the factor risk $F_{i j s}$. We will come back to addressing whether the former should be diagonal below.
}

We will discuss what $\zeta_{i s}$ should be in a moment. For now, let us assume we know how to compute them and figure out what the weights $w_{i s}$ are based on the alpha expected returns $\eta_{i s}$ and the alpha portfolio risk modeled by $\Gamma_{i j s}$. As for stocks, let us fix $w_{i s}$ by maximizing the Sharpe ratio [Sharpe, 1994] of the alpha portfolio:
$$
\begin{equation*}
w_{i s}=\kappa \sum_{j=1}^{N} \Gamma_{i j s}^{-1} \eta_{j s} \tag{38}
\end{equation*}
$$

Here, for each date $s, \Gamma_{i j s}^{-1}$ is the $N \times N$ matrix inverse to $\Gamma_{i j s}$, and the overall normalization coefficient $\kappa$ is fixed via the normalization condition
$$
\begin{equation*}
\sum_{i=1}^{N}\left|w_{i s}\right|=1 \tag{39}
\end{equation*}
$$

We will see momentarily that the alpha weights $w_{i s}$ reduce to a familiar form.

\subsection*{3.1 Large $N$ Limit}

For our purposes here it is convenient to rewrite $\Gamma_{i j s}$ via $\Gamma_{i j s}=\zeta_{i s} \zeta_{j s} \gamma_{i j s}$, where
$$
\begin{equation*}
\gamma_{i j s}=\delta_{i j}+\sum_{A=1}^{M} \beta_{i A s} \beta_{j A s} \tag{40}
\end{equation*}
$$
and $\beta_{i A s}=\widetilde{\beta}_{i A s} / \zeta_{i s}$. Here $\widetilde{\beta}_{i A s}=\sum_{B=1}^{M} P_{i B s} \phi_{B A}$, and $\phi$ is the Cholesky decomposition of $\Phi$, so (in matrix notations) $\phi \phi^{T}=\Phi$. We then have
$$
\begin{equation*}
w_{i s}=\frac{\kappa}{\zeta_{i s}} \sum_{j=1}^{N} \gamma_{i j}^{-1} \frac{\eta_{j s}}{\zeta_{j s}}=\frac{\kappa}{\zeta_{i s}}\left[\frac{\eta_{i s}}{\zeta_{i s}}-\sum_{j=1}^{N} \sum_{A, B=1}^{M} \beta_{i A s} Q_{A B s}^{-1} \beta_{j B s} \frac{\eta_{j s}}{\zeta_{j s}}\right] \tag{41}
\end{equation*}
$$
where (for each date $s$ ) $Q_{A B s}^{-1}$ is the $M \times M$ matrix inverse to $Q_{A B s}=\delta_{A B}+q_{A B s}$, and $q_{A B s}=\sum_{i=1}^{N} \beta_{i A s} \beta_{i B s}$. The diagonal elements of this matrix are $Q_{A A s}=$ $1+\sum_{i=1}^{N} \beta_{i A s}^{2}$. In a moment we will argue that all $q_{A A s}=\sum_{i=1}^{N} \beta_{i A s}^{2} \gg 1$. Then we can expand $Q_{A B s}^{-1}$ as follows:
$$
\begin{equation*}
Q_{A B s}^{-1}=q_{A B s}^{-1}-\sum_{C=1}^{M} q_{A C s}^{-1} q_{C B s}^{-1}+\mathcal{O}\left(q^{-3}\right) \tag{42}
\end{equation*}
$$

Here (for each date s) $q_{A B s}^{-1}$ is the $M \times M$ matrix inverse to $q_{A B s}$. The first term in (42) gives the leading contribution of order $1 / N$ into $Q_{A B s}^{-1}$, the second term is the next-to-leading contribution of order $1 / N^{2}$, and the remaining terms in the expansion, which we schematically denoted as $\mathcal{O}\left(q^{-3}\right)$, are of order $1 / N^{3}, 1 / N^{4}$, etc. As we will see in a moment, we need to keep not just the leading term $q_{A B s}^{-1}$, but also the next-to-leading (second) term in (42), and we can safely discard the rest. ${ }^{23}$

So, why are all $q_{A A} \gg 1$ ? This is the case when [Kakushadze and Yu, 2017a]: i) $N$ is large, and ii) there is no "clustering" in the vectors $\beta_{i A}$. That is, we do not have vanishing or small values of $\beta_{i A}^{2}$ for most values of the index $i$ with only a small subset thereof having $\beta_{i A}^{2} \gtrsim 1$. Without such "clustering", which is not observed in practice, to have $q_{A A} \lesssim 1$, we would have to have $\beta_{i A}^{2} \ll 1$, i.e., $\gamma_{i j}$ and, therefore, $\Gamma_{i j}$ would be almost diagonal. Such a risk model would not describe realistic alphas. ${ }^{24}$

\footnotetext{
${ }^{23}$ One caveat here is that $q_{A B s}$ is (for now) assumed to be invertible. We will relax this below.
${ }^{24}$ In practice, alphas are not too highly correlated - this is because one does not wish to trade highly correlated alphas. However, empirically the average correlation between alphas is not tiny either (definitely, not of order $1 / N$ ) [Kakushadze, 2016b].
}

\subsection*{3.2 Stock Portfolio}

Let us now plug (41) and (42) into (34). Straightforward algebra yields:
$$
\begin{equation*}
w_{A s}=\kappa \sum_{i=1}^{N} \sum_{B, C=1}^{M} \Phi_{A B}^{-1} \widetilde{Y}_{B C s} \widetilde{v}_{i s} P_{i C s} \eta_{i s}+\ldots \tag{43}
\end{equation*}
$$
where the ellipses stand for subleading terms corresponding to the $\mathcal{O}\left(q^{-3}\right)$ contributions in (42), $\widetilde{v}_{i s}=1 / \zeta_{i s}^{2}$, and $\widetilde{Y}_{A B s}$ is the inverse of the matrix
$$
\begin{equation*}
\widetilde{X}_{A B s}=\sum_{i=1}^{N} \widetilde{v}_{i s} P_{i A s} P_{j A s} \tag{44}
\end{equation*}
$$
I.e., here we have the exact same result as that given by (13), (8) and (9) provided that we identify $\zeta_{i s}$ with $\xi_{i s}$. More precisely, this identification is up to an overall ( $s$-dependent) constant, which does not affect the final result. This overall normalization constant plays the role of the relative normalization between the specific risk and factor risk in (37) and is nontrivial to fix as it depends on the normalization used in constructing the stock risk model covariance matrix $\Phi_{A B}$. However, the beauty of the large $N$ limit is that we do not need to know this normalization constant as it only affects the subleading terms suppressed by powers of $1 / N$ (i.e., the terms corresponding to the ellipses in (43)). Also, note that the leading contribution in (43) comes from the next-to-leading (second) term in (42). There is a simple reason for this. Suppose we kept only the leading (first) term in (42). We would then get $w_{A s} \equiv 0$. Indeed, keeping the leading term in (42) reduces (41) to a weighted cross-sectional regression [Kakushadze and Yu, 2017a] of $\eta_{i s}$ over $P_{i A s}$ (with the weights $1 / \zeta_{i s}^{2}$ ). Then $w_{i s}$ are automatically orthogonal to $P_{i A s}$, so $w_{A s}$ (given by (34)) automatically vanish, even though $w_{i s}$ do not! This is because the alpha portfolio is perfectly hedged against the risk factors, which are nothing but the stock returns. So, the combined alpha portfolio has exactly zero stock holdings. To obtain a nontrivial stock portfolio, we must relax this perfect hedge, i.e., move away from the exact regression to optimization. Keeping the next-to-leading term in (42) accomplishes exactly that. And, happily, precisely because $N$ is large, all the other terms are suppressed and we do not even need to fix the relative normalization between the specific and factor risks, which only affects these suppressed terms.

One loose end we need to tie up is that above we assumed that $q_{A B}$ is invertible. This is the case if we do not have linear constraints. In the presence of linear constraints (17) $q_{A B}$ is singular. It can be regularized as in Subsection 2.4 and then the rest of the argument goes through. The net result is that
$$
\begin{equation*}
w_{A s}=\kappa \sum_{i=1}^{N} \sum_{B, C=1}^{M} \sum_{a \in J} \Phi_{A B}^{-1}\left[\lambda_{s}^{(a)}\right]^{-1} V_{B s}^{(a)} V_{C s}^{(a)} v_{i s} P_{i C s} \eta_{i s}+\ldots \tag{45}
\end{equation*}
$$
where the notations are the same as in Subsection 2.4 (ellipses $=$ subleading terms).

\subsection*{3.3 A Tweak}

In the alpha risk model (37) we treat the position data $P_{i A s}$ as the factor loadings matrix (for each date $s$ ) and thereby stock returns are identified with the risk factor returns. The remainder of the risk is assumed to be diagonal specific risk, and $\zeta_{i s}^{2}$ are identified - up to an overall (s-dependent) normalization factor, which we do not need to compute for the reasons discussed above ${ }^{25}$ - with the $d$-day moving variances $\xi_{i s}^{2}$ of the regression residuals (see above). 


$$
\begin{align*}
& \Xi_{i j s}=\operatorname{Cov}\left(\epsilon_{i s}, \epsilon_{j s}, d\right)=\frac{1}{d-1} \sum_{s^{\prime}=s+1}^{s+d}\left(\epsilon_{i s^{\prime}}-\bar{\epsilon}_{i s}\right)\left(\epsilon_{j s^{\prime}}-\bar{\epsilon}_{j s}\right)  \tag{46}\\
& \bar{\epsilon}_{i s}=\frac{1}{d} \sum_{s^{\prime}=s+1}^{s+d} \epsilon_{i s^{\prime}} \tag{47}
\end{align*}
$$

This is equivalent (for each date $s$ ) to modeling the ( $d$-day moving) sample covariance matrix of the regression residuals $\epsilon_{i s}$ via a diagonal matrix $\operatorname{diag}\left(\Xi_{i j s}\right)=\Xi_{i i s} \delta_{i j}=\xi_{i s}^{2} \delta_{i j}$. There are other possibilities here. We can approximate $\Xi_{i j s}$ via a non-diagonal matrix $\widetilde{\Xi}_{i j s}$ so long as it is positive-definite. Generally, the rank of the $N \times N$ matrix $\Xi_{i j s}$ equals $d-1 \ll N$. Let its principal components with positive eigenvalues $\theta_{s}^{(r)}$ be $U_{i s}^{(r)}, r=1, \ldots, d-1$. Let us order the eigenvalues in the descending order: $\theta_{s}^{(1)}>\theta_{s}^{(2)}>\cdots>\theta_{s}^{(d-1)}$. Then we can construct $\widetilde{\Xi}_{i j s}$ as a $K_{s}$-factor statistical risk model (see, e.g., [Kakushadze and Yu, 2017b]) using the first $K_{s}<d-1$ principal components:
$$
\begin{align*}
& \widetilde{\Xi}_{i j s}=\widetilde{\xi}_{i s}^{2} \delta_{i j}+\sum_{r=1}^{K_{s}} \theta_{s}^{(r)} U_{i s}^{(r)} U_{j s}^{(r)}  \tag{48}\\
& \widetilde{\xi}_{i s}^{2}=\xi_{i s}^{2}-\sum_{r=1}^{K_{s}} \theta_{s}^{(r)}\left[U_{i s}^{(r)}\right]^{2} \tag{49}
\end{align*}
$$

Alternatively, we can model the sample correlation matrix $\Psi_{i j s}=\Xi_{i j s} / \xi_{i s} \xi_{j s}\left(\Psi_{i i s} \equiv\right.$ 1) via a $K_{s}$-factor statistical risk model:
$$
\begin{align*}
& \widetilde{\Xi}_{i j s}=\xi_{i s} \xi_{j s} \widetilde{\Psi}_{i j s}  \tag{50}\\
& \widetilde{\Psi}_{i j s}=\widetilde{\psi}_{i s}^{2} \delta_{i j}+\sum_{r=1}^{K_{s}} \phi_{s}^{(r)} S_{i s}^{(r)} S_{j s}^{(r)}  \tag{51}\\
& \widetilde{\psi}_{i s}^{2}=1-\sum_{r=1}^{K_{s}} \phi_{s}^{(r)}\left[S_{i s}^{(r)}\right]^{2} \tag{52}
\end{align*}
$$

\footnotetext{
${ }^{25}$ So, without affecting the final result, here we will set it to 1 for notational simplicity. This is equivalent to assuming that the stock risk model covariance matrix $\Phi_{A B}$ is properly normalized, albeit, once again, this overall normalization is immaterial at the end of the day.
}

Here $\phi_{s}^{(r)}(r=1, \ldots, d-1)$ are the positive eigenvalues of the sample correlation matrix $\Psi_{i j s}\left(\phi_{s}^{(1)}>\phi_{s}^{(2)}>\cdots>\phi_{s}^{(d-1)}\right)$ and $S_{i s}^{(r)}$ are the corresponding eigenvectors.

Following [Kakushadze and Yu, 2017b], the number of factors $K_{s}$ can be fixed using the effective rank (or eRank) [Roy and Vetterli, 2007]: $K_{s}=$ floor $\left(\operatorname{eRank}\left(\mathcal{A}_{i j s}\right)\right)$ or $K_{s}=\operatorname{round}\left(\operatorname{eRank}\left(\mathcal{A}_{i j s}\right)\right)$, where $\mathcal{A}$ stands for the sample covariance matrix $\Xi$ or the sample correlation matrix $\Psi$. Here we can simplify things a bit and have uniform $K$ for all values of $s$, e.g., $K=\min \left(K_{s}\right)$. In the discussion below, for the sake of definiteness, let us assume uniform $K_{s} \equiv K$ in the factor models (48) based on the principal components of the sample covariance matrix (this is not critical).

So, now our alpha risk model covariance matrix instead of (37) is given by
$$
\begin{equation*}
\widetilde{\Gamma}_{i j s}=\widetilde{\Xi}_{i j s}+F_{i j s}=\widetilde{\xi}_{i s}^{2} \delta_{i j}+\sum_{\widetilde{A}, \widetilde{B} \in H} \widetilde{P}_{i \widetilde{A} s} \widetilde{\Phi}_{\widetilde{A} \widetilde{B}} \widetilde{P}_{j \widetilde{B} s} \tag{53}
\end{equation*}
$$
where the set $H=\{A\} \cup\{r\}$ (so $|H|=M+K$ ) is the union of the values of the indices $A, B, \cdots=1, \ldots, M$ and the eigenvalue label $r=1, \ldots, K$, and $\widetilde{P}_{i A s}=P_{i A s}$, $\widetilde{P}_{i r s}=\left[\theta_{s}^{(r)}\right]^{1 / 2} U_{i s}^{(r)}$. Also, $\widetilde{\Phi}_{A B}=\Phi_{A B}, \widetilde{\Phi}_{r r^{\prime}}=\delta_{r r^{\prime}}$, and other components vanish. Now, the regression residuals $\epsilon_{i s}$ by definition are orthogonal to $P_{i A s}$, so we have $\sum_{i=1}^{N} \epsilon_{i s} P_{i A s} \equiv 0$. This implies that $\sum_{i=1}^{N} U_{i s}^{(r)} P_{i A s} \equiv 0$. Straightforward algebra then yields a simple result: the stock portfolio weights are still given by (45) with the only difference that now $v_{i s}=1 / \widetilde{\xi}_{i s}^{2}$ (as opposed to $v_{i s}=1 / \xi_{i s}^{2}$ ). I.e., the effect of modeling the matrix $\Xi_{i j s}$ via its principal components simply reduces to modifying the regression weights. So, the choice of $v_{i s}$ encodes the difference between models! ${ }^{26}$

\footnotetext{
${ }^{26}$ Here one may wonder how to control the stock portfolio turnover as high turnover alphas may increase it. A simple method is to suppress the weights $v_{i s}$ for high turnover alphas.
${ }^{27}$ For a general discussion and references, see, e.g., [Grinold and Kahn, 2000]. For a detailed construction (including important details overlooked in prior literature and commercial offerings) and explicit implementation complete with source code, see [Kakushadze and Yu, 2016].
}


\section*{4 Concluding Remarks}

As mentioned above, there is an overall normalization coefficient between the specific risk and factor risk terms in (37) (and thereby also in (53)). In fact, this overall normalization generally is $s$-dependent. It is related to the fact that the normalization of the stock risk model covariance matrix $\Phi_{A B}$ a priori is not the same as that of the resultant expected stock returns. However, as discussed above, for alpha portfolio optimization purposes we do not need to determine this overall normalization. This is because we are not actually inverting $\Gamma_{i j s}$; instead, we are running a regression over the position data $P_{i A s}$ with the weights $v_{i s}$ determined via the specific risks $\xi_{i s}$.

This is different from the risk model building for stocks, ${ }^{27}$ where one constructs a full multifactor risk model matrix $\Phi_{A B}$ with no undetermined normalization factors, etc. So, why is there such a glaring difference between stock and alpha risk models? The answer is simple. In stock risk models the industry-based risk factors play a dominant role, notably, by their ubiquity (as opposed to style factors or principal components - see [Kakushadze and Yu, 2016]). For the industry-based risk factors the corresponding factor loadings matrix $\Omega_{A I}$ (where $I$ labels industries) does, in fact, have a "clustering" structure; e.g., for binary industry classifications $\Omega_{A I}=1$ if the stock labeled by $A$ belongs to the industry labeled by $I$, otherwise $\Omega_{A I}=0$. Therefore, Sharpe ratio maximization based on such $\Phi_{A B}$ does not reduce to a regression. ${ }^{28}$ In some sense, alpha risk models are "simpler" than stock risk models.

Speaking of stock risk models, what should we use for $\Phi_{A B}$ ? Off-the-shelf commercial risk models might appear as a natural choice. However, for the reasons discussed in detail in [Kakushadze and Liew, 2015], for short-horizon trading applications custom-built risk models are preferable, especially when open source code for heterotic risk models [Kakushadze, 2015] and heterotic CAPM [Kakushadze and $\mathrm{Yu}, 2016]$ is freely available. This paper for alphas is in some sense analogous to [Kakushadze and $\mathrm{Yu}, 2016]$ for stocks: it provides source code for extracting stock returns from alphas directly, bypassing "alpha combos" altogether. The implication goes beyond by-now-standard quant trading based on ephemeral alphas. These expected returns can be used for other purposes. For instance, knowing short-horizon stock expected returns can be useful to institutional portfolio managers in gauging when to execute their (typically, large) orders and thereby potentially mitigate at least some market impact effects. In this regard it is important to keep in mind that constrained alphas yield accordingly constrained stock expected returns. E.g., if all alphas are dollar-neutral, the resulting stock expected returns are demeaned: we cannot forecast the overall movement of the broad market using dollar-neutral portfolios. ${ }^{29}$ Thus, developing a large number of unconstrained alphas is warranted.

For quant trading, apart from reducing noise and suboptimality introduced by alpha combos, one immediate benefit of our new method is that hedge funds no longer need to pay (about $3 \%$ of the P\&L) for alpha combos (on top of about $10 \%$ for alphas). At the end, the difference between different models (or alpha combos) reduces to picking the regression weights $v_{i s}$ (which may include, e.g., turnover suppression, etc. - see fn. 26). Why would anyone want to pay for that? Albeit, paraphrasing, avaritia caecus est... In any event, let us finally note that we present no backtests in this paper as the position and other data are highly proprietary.

\footnotetext{
${ }^{28}$ In contrast, Shape ratio maximization using stock risk models based solely on style factors and/or principal components always reduces to a regression (assuming $M>1$ ). This also applies to the so-called "shrinkage" models [Ledoit and Wolf, 2004], which are special cases of principal components based models [Kakushadze and Yu, 2017b].
${ }^{29}$ Notwithstanding that dollar neutrality does not necessarily equal market neutrality.
}

\section*{A R Code for Stock Expected Returns}

In this appendix we give the R source code ${ }^{30}$ for extracting stock expected returns from alpha expected returns. The code below is essentially self-explanatory and straightforward as it simply follows the algorithms and formulas in Sections 2 and 3. The entry function is stk.exp.ret(ret, hld, k, tol $=1 \mathrm{e}-8$ ). Here ret is an $N \times d$ matrix $\eta_{i s}$ of alpha expected returns, where the most recent date corresponds to $s=1$; hld is a 3 -dimensional $N \times M \times d$ array $P_{i A s}$ of stock positions; k is the input (see below) number of principal components $K$ used in modeling the matrix $\widetilde{\Xi}_{i j s} ;$ tol is used in dealing with rounding errors (to wit, to distinguish null eigenvalues). Internally the function stk.exp.ret() calls the function calc.spec.var(), which internally calls the function calc.erank(). For $K=0$ or $K \geq d-2$ the code sets $K=0$, i.e., no principal components are used. For $K<0$ the code sets $K$ using eRank (truncated to an integer - it is straightforward to change it to rounding). For $0<K<d-2$ the code uses this input value for the number of principal components. Internally the function calc.spec.var() also calls the function qrm.calc.eigen.eff() given in Appendix C of [Kakushadze and Yu, 2017b], which provides a much more efficient method (not based on power iterations) for computing eigenpairs than the internal R function (which is based on power iterations [Mises and Pollaczek-Geiringer, 1929]). ${ }^{31}$ The function stk.exp.ret () returns the vector $E_{i}=E_{i, s=1}$ of the stock expected returns for the most recent date $s=1$. The code only uses data with $s>1$ to compute the regression weights out-of-sample.
```
calc.erank <- function (x, excl.first)
{
    take <- x > 0
    x <- x[take]
    if(excl.first)
            x <- x[-1]
    p <- x / sum(x)
    h <- - sum(p * log(p))
    er <- exp(h)
    if(excl.first)
        er <- er + 1
    return(er)
}
calc.spec.var <- function (x, k, do.trunc = T)
{
    m <- ncol(x) - 1
    if(k == 0 | k >= m)
```

\footnotetext{
${ }^{30}$ The R Project for Statistical Computing, www.r-project.org.
${ }^{31}$ For large $N$ using the internal R function eigen() here would be computationally prohibitive.
}
```
        return(apply(x, 1, var))
    x.e <- qrm.calc.eigen.eff(x)
    x.val <- x.e$values
    x.vec <- x.e$vectors
    if(k < 0)
    {
        k <- calc.erank(x.val, excl.first = F)
        if(do.trunc)
            k <- trunc(k)
        else
            k <- round(k)
    }
    if(length(take <- (k+1):m) == 1)
        return(x.vec[, take]^2 * x.val[take])
    return(colSums(t(x.vec[, take])^2 * x.val[take]))
}
stk.exp.ret <- function (ret, hld, k, tol = 1e-8)
{
    n <- nrow(ret)
    d <- ncol(ret)
    res <- matrix(NA, n, d - 1)
    for(s in 2:d)
        res[, s - 1] <- residuals(lm(ret[, s] ~ -1 + hld[, , s]))
    v <- 1 / calc.spec.var(res, k)
    x <- t(hld[, , 1]) %*% (v * hld[, , 1])
    x.e <- eigen(x)
    x.val <- x.e$values
    x.vec <- x.e$vectors
    take <- x.val > tol * x.val[1]
    x.val <- x.val[take]
    x.vec <- x.vec[, take]
    stk <- colSums(hld[, , 1] * v * ret[, 1])
    stk <- colSums(x.vec * stk) / x.val
    stk <- colSums(t(x.vec) * stk)
    return(stk)
}
```

\section*{B DISCLAIMERS}

Wherever the context so requires, the masculine gender includes the feminine and/or neuter, and the singular form includes the plural and vice versa. The author of this paper ("Author") and his affiliates including without limitation Quantigic ${ }^{\circledR}$ Solutions LLC ("Author's Affiliates" or "his Affiliates") make no implied or express warranties or any other representations whatsoever, including without limitation implied warranties of merchantability and fitness for a particular purpose, in connection with or with regard to the content of this paper including without limitation any code or algorithms contained herein ("Content").

The reader may use the Content solely at his/her/its own risk and the reader shall have no claims whatsoever against the Author or his Affiliates and the Author and his Affiliates shall have no liability whatsoever to the reader or any third party whatsoever for any loss, expense, opportunity cost, damages or any other adverse effects whatsoever relating to or arising from the use of the Content by the reader including without any limitation whatsoever: any direct, indirect, incidental, special, consequential or any other damages incurred by the reader, however caused and under any theory of liability; any loss of profit (whether incurred directly or indirectly), any loss of goodwill or reputation, any loss of data suffered, cost of procurement of substitute goods or services, or any other tangible or intangible loss; any reliance placed by the reader on the completeness, accuracy or existence of the Content or any other effect of using the Content; and any and all other adversities or negative effects the reader might encounter in using the Content irrespective of whether the Author or his Affiliates is or are or should have been aware of such adversities or negative effects.

The R code included in Appendix A hereof is part of the copyrighted R code of Quantigic ${ }^{\circledR}$ Solutions LLC and is provided herein with the express permission of Quantigic ${ }^{\circledR}$ Solutions LLC. The copyright owner retains all rights, title and interest in and to its copyrighted source code included in Appendix A hereof and any and all copyrights therefor.

\section*{References}

Grinold, R.C. and Kahn, R.N. Active Portfolio Management. New York, NY: McGraw-Hill, 2000.

Kakushadze, Z. (2014) Factor Models for Alpha Streams. The Journal of Investment Strategies 4(1): 83-109.
Available online: http://ssrn.com/abstract=2449927.
Kakushadze, Z. and Liew, J.K.-S. (2015) Custom v. Standardized Risk Models. Risks 3(2): 112-138. Available online: http://ssrn.com/abstract=2493379.

Kakushadze, Z. (2015) Heterotic Risk Models. Wilmott Magazine 2015(80): 4055. Available online: http://ssrn.com/abstract $=2600798$.

Kakushadze, Z. (2016a) Shrinkage $=$ Factor Model. Journal of Asset Management 17(2): 69-72. Available online: http://ssrn.com/abstract=2685720.

Kakushadze, Z. (2016b) 101 Formulaic Alphas. Wilmott Magazine 2016(84): 72-80. Available online: http://ssrn.com/abstract=2701346.

Kakushadze, Z. and Tulchinsky, I. (2016) Performance v. Turnover: A Story by 4,000 Alphas. The Journal of Investment Strategies 5(2): 75-89. Available online: http://ssrn.com/abstract=2657603.

Kakushadze, Z. and Yu, W. (2016) Multifactor Risk Models and Heterotic CAPM. The Journal of Investment Strategies 5(4): 1-49.
Available online: http://ssrn.com/abstract=2722093.
Kakushadze, Z. and Yu, W. (2017a) How to Combine a Billion Alphas. Journal of Asset Management 18(1): 64-80.
Available online: http://ssrn.com/abstract=2739219.
Kakushadze, Z. and Yu, W. (2017b) Statistical Risk Models. The Journal of Investment Strategies 6(2): 1-40.
Available online: http://ssrn.com/abstract $=2732453$.
Ledoit, O. and Wolf, M. (2004) Honey, I Shrunk the Sample Covariance Matrix. The Journal of Portfolio Management 30(4): 110-119.

Markowitz, H. (1952) Portfolio selection. The Journal of Finance 7(1): 77-91.
Mises, R.V. and Pollaczek-Geiringer. H. (1929) Praktische Verfahren der Gleichungsauflösung. ZAMM - Zeitschrift für Angewandte Mathematik und Mechanik 9(2): 152-164.

Roy, O. and Vetterli, M. (2007) The effective rank: A measure of effective dimensionality. In: Proceedings - EUSIPCO 2007, 15th European Signal Processing Conference. Poznań, Poland (September 3-7), pp. 606-610.

Sharpe, W.F. (1994) The Sharpe Ratio. The Journal of Portfolio Management 21(1): 49-58.
