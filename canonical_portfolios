\title{
Canonical Portfolios: Optimal Asset and Signal Combination*
}


\begin{abstract}
This paper presents a novel framework for analyzing the optimal asset and signal combination problem. Our approach builds upon the dynamic portfolio selection problem introduced by Brandt and Santa-Clara (2006) and consists of two stages. First, we reformulate their original investment problem into a tractable one that allows us to derive a closed-form expression for the optimal portfolio policy that is scalable to large cross-sectional financial applications. Second, we recast the problem of selecting a portfolio of correlated assets and signals into selecting a set of uncorrelated managed portfolios through the lens of Canonical Correlation Analysis of Hotelling (1936). The new investment environment of uncorrelated managed portfolios offers unique economic insights into the joint correlation structure of our optimal portfolio policy. We also operationalize our theoretical framework to bridge the gap between theory and practice, showcasing the improved performance of our proposed method over natural competing benchmarks.
\end{abstract}


\section*{1 Introduction}

The investment decisions of portfolio managers are often guided by return-predictive signals that reflect their expectations about future returns. ${ }^{1}$ Traditionally, the process of constructing a portfolio conditional on the investor's information set is divided into two stages according to modern portfolio theory pioneered by Markowitz (1952). In the first stage, investors make inferences about the return-generating process by either plug-in estimation or subjective belief formation. In the second stage, optimal portfolio weights are formed using estimates from the first stage.

In this paper, we draw inspiration from Brandt and Santa-Clara (2006) and solve a dynamic portfolio selection problem with multiple return-predictive signals in a single stage. Our first contribution is to reformulate the authors' original investment problem into a tractable one that yields a dynamic portfolio policy that directly invests in each basis asset. Additionally, our approach provides a theoretical framework for optimal investment in the presence of cross-predictability among assets and signals, as well as correlations within them. Our proposed solution is straightforward to implement in practice as the standard static Markowitz solution and is well-suited to handle large-scale cross-sectional applications, such as the equity universe.

The second contribution of our work is to provide insights into our proposed solution by reorganizing the set of assets and accompanying signals into a set of uncorrelated managed portfolios. Each managed portfolio invests in each asset in a proportion that scales with the size of the signals (Cochrane, 2001). As discussed in Firoozye and Koshiyama (2020, Section 4), this can be accomplished through the use of a powerful tool from multivariate analysis known as canonical correlation analysis (CCA), which was developed by Hotelling (1936) and has a deep economic interpretation, which we provide. CCA generalizes the principal component analysis (PCA) of Hotelling (1933) to two sets of random variables and their joint association. This makes it particularly relevant to our case, where we have multiple correlated assets and signals that are mutually linked by a joint correlation objective. CCA allows us to express any portfolio returns derived from our framework in terms of their exposures to uncorrelated sources of returns, by reweighting the original set of managed portfolio returns while maximally retaining their correlation. We refer to these special weights as canonical portfolios since they can be viewed as long or short positions across different assets and signals. ${ }^{2}$

\footnotetext{
${ }^{1}$ The terminology 'signals' is also often referred to as predictors, alphas, attributes, characteristics, state variables, instrumental variables, cross-sectional anomalies, etc. in the finance literature.
${ }^{2}$ The idea of recasting the asset universe into their orthogonal components through PCA can be traced back to Partovi and Caputo (2004) with further extensions and applications from Meucci (2009) and Avellaneda and Lee (2010), as well as from Kozak et al. $(2018,2020)$ in the context of risk pricing in a no near-arbitrage framework. Our work aims to broaden that horizon to two sets of variables by also considering the signal as an important input in the analysis of their joint association with returns.
}

There are two common approaches for solving the dynamic portfolio selection problem when conditioning information is available. The first approach involves specifying the joint conditional distribution of asset returns and then forming the optimal portfolio. Alternatively, Hansen and Richard (1987) proposed a second approach, which involves augmenting the basis assets to include conditional portfolios, and solving a simpler unconditional mean-variance problem. Research efforts that have built upon the latter approach to developing dynamic trading strategies that exploit timevarying investment opportunities include those by Ferson and Siegel (2001), Brandt and Santa-Clara (2006), and others. Of particular relevance to our study is Brandt and Santa-Clara (2006), in which the authors analyze parametric portfolio policies that are linear in the state variables and/or firm characteristics. Through this parameterization, they are able to recast a dynamic portfolio selection problem involving basis assets into a static portfolio selection problem in an asset space augmented with managed portfolios. The optimization of parameters in the static problem leads to a dynamic strategy represented as a fixed combination of managed portfolios, which consists of "conditional" and "timing" portfolios. By directly focusing on the portfolio weights, their optimal portfolio policy accounts for time-variation in the entire return distribution, rather than time-variation in expected returns only.

In this study, we directly model the portfolio weights with a similar parameterization and adopt a joint Gaussian distribution to model the relationship between returns and signals. Our modeling approach allows us to make analytical progress in two main areas. First, it facilitates the derivation of a closed-form dynamic portfolio policy that is applicable even in large-dimensional settings. Second, it allows us to decompose the joint correlation structure of our optimal portfolio policy into linearly independent orthogonal portfolios using CCA, thereby providing valuable insights into the underlying factors that drive our portfolio's performance.

However, these innovations come with additional input requirements when compared to the conventional mean-variance framework, which solely relies on the covariance of the returns matrix. Specifically, we need to consider the covariance of the signals and the cross-covariances between the returns and signals. To render our theoretical framework practicable, we utilize regularization techniques for these large-dimensional objects to encourage stability in the out-of-sample results. In particular, we apply shrinkage to the covariances, a technique commonly employed in portfolio selection problems; see, for example, Frost and Savarino (1986) and Ledoit and Wolf (2004a,b, 2017). Additionally, we identify the leading few canonical portfolios that exhibit the highest predictability, discarding noisy and unstable ones. Through a series of backtesting simulations, we demonstrate that our proposed method consistently outperforms competitive benchmarks.

Our study extends the work of Firoozye and Koshiyama (2019) on the use of total least squares (TLS) (Golub and Van Loan, 1980) for optimally combining signals for a univariate return. Their original study focused on a novel objective function for return prediction. While most research analysts will seek to find a good forecast for future returns via methods such as ordinary least squares (OLS), or in the nonlinear context, via a large suite of machine learning-based methods, Firoozye and Koshiyama $(2019,2020)$ argue that if the goal is to maximize the Sharpe ratio of trading strategy, then this can be achieved through a linear combination of signals that maximizes the correlation between their combination and the returns. In the linear context, the solution to this problem comes out via TLS, which is an errors-in-variables formulation of regression. TLS has been well-studied primarily among numerical analysts and is used less formally on trading desks of
investment banks and hedge funds, typically under the moniker of PCA regression. Given the close relation between TLS and CCA, our work extends this research to a multivariate context, which is more relevant for problems in portfolio selection.

The remainder of the paper is organized as follows. Section 2 gives the description of our dynamic portfolio selection problem. Section 3 provides the financial interpretation of our optimal portfolio policy with CCA and details our proposed estimation approach. Section 4 describes the empirical methodology and presents the results of the out-of-sample backtest experiments with Fama-French equity sorted portfolios. Section 5 concludes. Appendix $A-B$ contain all the figures, tables, and additional mathematical derivations.

\section*{2 Setting the Stage}

\subsection*{2.1 Notation}

In this section, we introduce the notational convention for our analysis. Let the subscript $i$ index the variables such that $i \in\{1, \ldots, N\}$, where $N$ denotes the dimension of the asset universe. The subscript $t$ indexes the trading dates such that $t \in\{1, \ldots, T\}$, where $T$ denotes the number of observations. The notation $\mathbb{E}_{t}[\cdot]:=\mathbb{E}\left[\cdot \mid \mathcal{F}_{t}\right]$ represents the mathematical expectation operator of a random vector, conditioned on the information set $\mathcal{F}_{t}$ available at time $t$. Furthermore, $\operatorname{Cov}(\cdot, \cdot)$ represents the covariance matrix between two random vectors, $\operatorname{Tr}(\cdot)$ represents the trace of a square matrix, and $\operatorname{Diag}(\cdot)$ represents a diagonal matrix of a given vector. Denote $\mathbb{I}_{N}$ to be an identity matrix of dimensions $N \times N$. For any $N$-dimensional vector $z$, its $\ell_{2}$-norm is given by $\|z\|_{2}:=\sqrt{z_{1}^{2}+\ldots z_{N}^{2}}$, and for any real matrix $Z$, its Frobenius norm is $\|Z\|_{\mathrm{F}}:=\sqrt{\operatorname{Tr}\left(Z^{\prime} Z\right)}$. Here, the symbol ( ${ }^{\prime}$ ) denotes the transpose operator of a vector or matrix, the symbol $:=$ is a definition sign, and the symbol $=$ is the equal sign.

Let $r_{t, i}$ be the return for a risky asset $i$ sampled at trading date $t$, stacked into a vector $r_{t}:=\left(r_{t, 1}, \ldots, r_{t, N}\right)^{\prime}$. Also, let $x_{t, i}$ be an $M$-dimensional vector return-predictive signal at date $t$ for asset $i$, stacked into a vector $x_{t}:=\left(x_{t, 1}, \ldots, x_{t, N}\right)^{\prime}$. This means every asset is accompanied by at least one signal and so $M$ is necessarily a positive integer. For example, if there are two signals for one asset, then $M=2$. The signals are understood to proxy the future expected returns conditional on the investor's information set at time $t$.

We impose the following assumptions to both the returns and signals whenever applicable.
Assumption 1 (Stationarity). The return sequence $\left\{r_{t+1}\right\}$ and the signal sequence $\left\{x_{t}\right\}$ exhibit stationarity and ergodicity, whose moments can be calculated by taking time-series averages.

Assumption 2 (Gaussianity). The returns and signals have multivariate distributions that are assumed to be Gaussian with zero expectations and covariances $\operatorname{Var}\left(r_{t+1}\right):=\operatorname{Cov}\left(r_{t+1}, r_{t+1}\right)=\Sigma_{r}$ and $\operatorname{Var}\left(x_{t}\right):=\operatorname{Cov}\left(x_{t}, x_{t}\right)=\Sigma_{x}$, and a cross-covariance $\operatorname{Cov}\left(r_{t+1}, x_{t}\right)=\Sigma_{r x}=\Sigma_{x r}^{\prime}$. The column vector of stacked subsequent returns and signals $\left(r_{t+1}, x_{t}\right)^{\prime}$ has a joint covariance matrix expressed
in the following partitioned form:
$$
\Sigma=\left(\begin{array}{cc}
\Sigma_{r} & \Sigma_{r x}  \tag{1}\\
\Sigma_{r x}^{\prime} & \Sigma_{x}
\end{array}\right)
$$

In our notation, we denote estimated quantities of their population analogs with a hat accent ( ${ }^{\wedge}$ ) on them. We use $S_{r}, S_{x}$, and $S_{r x}$ to represent the sample covariances between the asset returns and signals, the sample covariances of the signals themselves, and the sample cross-covariance between the returns and signals, respectively. Specifically, $S_{r}$ is computed as $T^{-1} \sum_{t=0}^{T-1}\left(r_{t+1}-\bar{r}\right)\left(r_{t+1}-\bar{r}\right)^{\prime}$, where $\bar{r}$ is the sample mean of the returns. Similarly, $S_{x}$ is computed as $T^{-1} \sum_{t=0}^{T-1}\left(x_{t}-\bar{x}\right)\left(x_{t}-\bar{x}\right)^{\prime}$, where $\bar{x}$ is the sample mean of the signals. Finally, $S_{r x}$ is computed as $T^{-1} \sum_{t=0}^{T-1}\left(r_{t+1}-\bar{r}\right)\left(x_{t}-\bar{x}\right)^{\prime}$.

Due to the symmetric positive semidefinite property of the covariance matrices, they admit a spectral decomposition. For example, $\Sigma_{r}=P_{r} \operatorname{Diag}\left(d_{r, 1}, \ldots, d_{r, N}\right) P_{r}^{\prime}$, where $P_{r}:=\left[p_{r, 1}, \ldots, p_{r, N}\right]$ is an orthogonal matrix $\left(P_{r}^{\prime} P_{r}=P_{r} P_{r}^{\prime}=\mathbb{I}_{N}\right)$ whose columns contain the eigenvectors and $\operatorname{Diag}\left(d_{r, 1}, \ldots, d_{r, N}\right)$ is a diagonal matrix containing the eigenvalues. The eigenvalues are assumed to be sorted in ascending order. The matrix factor $\Sigma_{r}^{1 / 2}$ can be obtained by retaining the eigenvectors of $\Sigma_{r}$, but reassembling them with the square roots of the eigenvalues given by $\left(\sqrt{d_{r, 1}}, \ldots, \sqrt{d_{r, N}}\right)^{\prime}$. An analogous notation applies for the decomposition of the covariance of signals $\Sigma_{x}$ and its matrix of factors $\Sigma_{x}^{1 / 2}$.

\subsection*{2.2 Dynamic Trading Strategies}

We begin our analysis by considering the portfolio policies to be linear in the vector of signals at time $t$ based on the following specification.

Assumption 3 (Linear Portfolio Policies). Let $w_{t}:=A^{\prime} x_{t}$, where $A$ is a $N M \times N$ constant matrix of coefficients. ${ }^{3}$

The portfolio weights are conditional on the strength of the signals but the matrix $A$ is a static object where column $i$ maps the signal vector to the corresponding portfolio weight invested in basis asset $i$. From this parameterization, the dynamic portfolio selection problem that an investor faces at time $t$ can be formulated in terms of a conditional mean-variance objective as follows
$$
\begin{equation*}
\max _{A} \mathbb{E}_{t}\left[x_{t}^{\prime} A r_{t+1}\right]-\frac{\gamma}{2} \operatorname{Var}_{t}\left[x_{t}^{\prime} A r_{t+1}\right] \tag{2}
\end{equation*}
$$
where $\gamma$ is an investor's risk aversion parameter. ${ }^{4}$ This objective function underscores that the investor chooses to simultaneously allocate between the assets and signals in order to yield a trading strategy that optimizes the returns of the portfolio at time $t+1$, which we denote as $r_{t+1}^{w}$.

\footnotetext{
${ }^{3}$ Note that the assumption that the optimal portfolio weights are linear functions of the signals is not entirely restrictive. Indeed, each of the signals in $x_{t}$ can be composed of non-linear functions of a more primitive set of underlying signals.
${ }^{4}$ Other reformulations of this problem include the maximization of mean return or minimization of risk. Regardless of the choice, all three problems result in the same mean-variance trade-off.
}

Brandt and Santa-Clara (2006) showed that this problem formulation is equivalent to an unconditional portfolio selection problem since the matrix of coefficients is constant through time and Assumption 1 holds. Thus, the matrix $A$ that optimizes the investor's conditional problem at any given date is the same for all dates and hence, it also optimizes the investor's unconditional problem. Hence, we can drop the subscript $t$ in (2) and consider the following revised problem instead $^{5}$
$$
\begin{equation*}
\max _{A} \mathbb{E}\left[x_{t}^{\prime} A r_{t+1}\right]-\frac{\gamma}{2} \operatorname{Var}\left[x_{t}^{\prime} A r_{t+1}\right] \tag{3}
\end{equation*}
$$

If we further invoke Assumption 2, we can express this objective in terms of the unconditional second-moments with the following proposition.

Proposition 1. The objective function to the investor's problem (3) is given by
$$
\begin{equation*}
\max _{A} \operatorname{Tr}\left(A \Sigma_{r x}\right)-\frac{\gamma}{2}\left(\operatorname{Tr}\left(\Sigma_{x} A \Sigma_{r} A^{\prime}\right)+\operatorname{Tr}\left(\Sigma_{r x} A \Sigma_{r x} A\right)\right) \tag{4}
\end{equation*}
$$

A closed-form expression for matrix $A$ is provided in Theorem 2 from Appendix B.
It is analytically convenient to assume that $\operatorname{Tr}\left(\Sigma_{r x} A \Sigma_{r x} A\right) \approx 0$ in Proposition 1 . This approximation offers the advantage of formulating the optimal portfolio policy solely based on unconditional moments, without any recourse to canonical correlation analysis, which is necessary to solve the investment problem (4). It is a reasonable approximation as long as the weighted sum contributions of squared expected returns from the dollar-neutral managed portfolios, represented as $x_{t}$ multiplied by the return of each asset, are small and can be approximated as zero. ${ }^{6}$ Notwithstanding this approximation, we have further validated both the exact and approximate solutions empirically in Section 4.

\footnotetext{
${ }^{5}$ Note that Equations (2) and (3) are not generally the same when time-varying covariances are present; see Ang and Bekaert (2002). However, we will defer the investigation of this setting to future research endeavors.
${ }^{6}$ For instance, if a portfolio managed on the basis of momentum signals has an average return of $5 \%$, then the square of its return is $0.25 \%$.
}

Proposition 2. Consider the following objective function
$$
\begin{equation*}
\max _{A} \operatorname{Tr}\left(A \Sigma_{r x}\right)-\frac{\gamma}{2} \operatorname{Tr}\left(\Sigma_{x} A \Sigma_{r} A^{\prime}\right) \tag{5}
\end{equation*}
$$

The solution to the investor's problem (5) is given by
$$
\begin{equation*}
A=\frac{1}{\gamma} \Sigma_{x}^{-1} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1} \tag{6}
\end{equation*}
$$

The weight $w_{t}$ allocated to each asset conditional on the signal at time $t$ is then
$$
\begin{equation*}
w_{t}=\frac{1}{\gamma} \Sigma_{r}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} x_{t} \tag{7}
\end{equation*}
$$

In the absence of any further constraints on $w_{t}$, this is the frictionless portfolio policy that invests directly in each asset, and the size of the portfolio is determined by the level of the investor's risk aversion. The dynamics of the portfolio are guided by the trajectory of the signal $x_{t}$ at each period. We see that the portfolio takes into account the cross-sectional information from the asset returns, the signals as well as their cross-relationships. The cross-covariance matrix $\Sigma_{r x}$ can be interpreted as a matrix consisting of managed portfolios that encapsulate the potential earnings opportunities that are available to an investor. ${ }^{7}$ For this reason itself, we term this matrix a 'conditional portfolios' matrix, which consists of returns scaled by their predictive signals.

\footnotetext{
${ }^{7}$ In Kelly et al. (2022), the authors term the cross-covariance matrix as the 'prediction matrix', which is also another valid interpretation since the correlation between an asset return and some signal is one measure of signal-return predictability. Given that a cross-covariance matrix is not symmetric in general, the predictive strength of a signal $i$ on asset $j$ may be different from that of signal $j$ on asset $i$.
}

We conclude this section by presenting two examples along with some remarks.
Example 1 (Univariate Portfolio). Let us consider one return-accompanying signal and postulate that all covariances in Equation (7) are the identity matrix. In this case, the weight is proportional to the conditioning variable, that is, $w_{t}=\gamma^{-1} x_{t}$. This portfolio policy is interesting in its own right because it ignores the impact that the returns and signals can have on the covariances. Hence, it is essentially a univariate system in which the signals only forecast their associated asset. We shall henceforth refer to this conditional portfolio as the univariate factor (UNI).

Example 2 (Two-Assets Portfolio). Suppose that $N=2, M=1$, and $\gamma=1$. If the asset returns and signals have unit variances, then the covariances are
$$
\Sigma_{r}=\left(\begin{array}{cc}
1 & \rho_{r}  \tag{8}\\
\rho_{r} & 1
\end{array}\right), \quad \Sigma_{x}=\left(\begin{array}{cc}
1 & \rho_{x} \\
\rho_{x} & 1
\end{array}\right), \quad \text { and } \quad \Sigma_{r x}=\left(\begin{array}{cc}
\xi_{11} & \xi_{12} \\
\xi_{21} & \xi_{22}
\end{array}\right)
$$

For simplicity, we also suppose that the signals are uncorrelated, that is, $\rho_{x}=0$. Inserting these objects into the optimal matrix $A$, we can write the weights invested in the two basis assets as
$$
\begin{equation*}
w_{t}=\left(\frac{\xi_{11}-\rho_{r} \xi_{21}}{1-\rho_{r}^{2}} x_{1}+\frac{\xi_{12}-\rho_{r} \xi_{22}}{1-\rho_{r}^{2}} x_{2}, \frac{\xi_{21}-\rho_{r} \xi_{11}}{1-\rho_{r}^{2}} x_{1}+\frac{\xi_{22}-\rho_{r} \xi_{12}}{1-\rho_{r}^{2}} x_{2}\right) \tag{9}
\end{equation*}
$$

Moreover, the expected portfolio return is
$$
\begin{equation*}
\operatorname{Tr}\left(A \Sigma_{r x}\right)=\operatorname{Tr}\left(\Sigma_{r}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} \Sigma_{r x}^{\prime}\right)=\frac{\xi_{11}^{2}+\xi_{12}^{2}+\xi_{21}^{2}+\xi_{22}^{2}-2 \rho_{r}\left(\xi_{11} \xi_{21}+\xi_{12} \xi_{22}\right)}{1-\rho_{r}^{2}} \tag{10}
\end{equation*}
$$

This expression is non-negative given $\rho_{r} \in[-1,1]$ since $\xi_{11}^{2}+\xi_{21}^{2} \geq 2 \rho_{r} \xi_{11} \xi_{21}$ and $\xi_{12}^{2}+\xi_{22}^{2} \geq 2 \rho_{r} \xi_{12} \xi_{22}$ by the inequality of arithmetic and geometric means. Let us consider three cases. First, if $\rho_{r}=0$, then the expected return is simply the squared expected returns of all conditional portfolios that exploit own- and cross-predictabilities. Second, if $\rho_{r} \in(-1,0)$, then there is an additional positive contribution to the conditional portfolios that arises from diversifying into imperfectly negatively correlated assets. The position is leveraged according to a factor of $1 /\left(1-\rho_{r}^{2}\right)$, which increases as $\left|\rho_{r}\right|$ approaches one from below. Third, if $\rho_{r} \in(0,1)$, then the expected portfolio return is now reduced since the gains to diversification are limited by the extent to which the assets are positively correlated. Notwithstanding the diminished returns, the optimal strategy is also leveraged with a factor $1 /\left(1-\rho_{r}^{2}\right)$ in order to increase the portfolio returns to meet its profit objective. A similar conclusion holds for the case $\rho_{r}=0$ and $\rho_{x} \neq 0$.

Remark 1 (Conditional Portfolio Policies). We can gain further intuition into the role of conditioning that our problem posits. Consider the following conditional portfolio selection problem:
$$
\begin{equation*}
\max _{w_{t}} \mathbb{E}_{t}\left[w_{t}^{\prime} r_{t+1}\right]-\frac{\gamma}{2} \operatorname{Var}_{t}\left[w_{t}^{\prime} r_{t+1}\right] \tag{11}
\end{equation*}
$$

Since the weights are known at time $t$, the problem can be solved to give
$$
\begin{equation*}
w_{t}=\frac{1}{\gamma} \operatorname{Var}_{t}\left[r_{t+1}\right]^{-1} \mathbb{E}_{t}\left[r_{t+1}\right] \tag{12}
\end{equation*}
$$

Observe that this optimal portfolio is determined by the mean and variance of returns that incorporate all available information up to time $t$. Hence, restricting the weights to be linear functions of a set of signals also restricts the solution set, which may lead to a suboptimal solution. However, specifying the conditional means and variances of the returns is a notoriously difficult task. Our weights restriction simplifies these dual tasks by converting a dynamic problem into an equivalent static problem for which a conditional portfolio policy is available solely in terms of the unconditional moments of the assets and signals.

Remark 2 (Regression-Based Policies). Notice that the portfolio weights (7) can be seen as one that had been obtained from a two-stage process of forecasting and asset allocation. To see this, let us consider the following return-generating process:
$$
\begin{equation*}
r_{t+1}=B^{\prime} x_{t}+\varepsilon_{t+1} \tag{13}
\end{equation*}
$$
where $B$ is a matrix of coefficients and $\varepsilon_{t}$ is an idiosyncratic error that is independent and identically distributed (i.i.d.). A simple forecasting approach that captures this relationship between both variables would be to perform an ordinary least squares (OLS) regression. In particular, one would first perform $N$ independent univariate OLS regressions of the returns to assets on the signals in order to obtain a vector of cross-sectional predictive signals and then insert them into (12) to arrive at the vector of allocations:
$$
\begin{equation*}
w_{t}=\frac{1}{\gamma} \Sigma_{\varepsilon}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} x_{t} \tag{14}
\end{equation*}
$$
where $\Sigma_{\varepsilon}:=\operatorname{Cov}\left(\varepsilon_{t}\right)=\Sigma_{r}-\Sigma_{r x} \Sigma_{x}^{-1} \Sigma_{r x}^{\prime}$ is the covariance matrix of the residuals. In fact, this portfolio is also optimal under our assumption of joint Gaussianity between the asset returns and signals. By invoking the standard properties of the multivariate Gaussian distribution, the conditional distribution of $r_{t+1}$ given $x_{t}$ is also multivariate Gaussian distributed with means and variances
given by
$$
\begin{align*}
\mathbb{E}_{t}\left[r_{t+1}\right] & =\Sigma_{r x} \Sigma_{x}^{-1} x_{t},  \tag{15}\\
\operatorname{Var}_{t}\left[r_{t+1}\right] & =\Sigma_{r}-\Sigma_{r x} \Sigma_{x}^{-1} \Sigma_{r x} . \tag{16}
\end{align*}
$$

Inserting these expressions into (12) gives portfolio (14). In contrast to our portfolio (7), this regression-based portfolio depends on the covariance structure of the unexplained parts of the returns. Another key difference here is that our portfolio policy respects symmetry; exchanging the roles of the assets and signals yields identical returns to the portfolio. This symmetry property may be warranted in situations where the signals have an influence on the asset returns but at the same time, the reverse association is also economically plausible. It also implies that our approach is more closely related to total least squares (TLS) than it is to OLS since TLS is an errors-in-variables regression model that optimizes for the correlation of both variables, which is a symmetric metric.

\subsection*{2.3 Fully Invested Constraint}

In quantitative equity investing, it is commonplace to impose economic constraints on the portfolio weights. A prominent example would be the fully-invested portfolio, which enforces a budget constraint so that the weights add to one. This equality constraint can be included in our optimization problem and given that it is linear in the matrix of coefficients $A$, the portfolio weights can be fortunately solved in closed form.

Proposition 3. We can formulate the optimal asset and signal combination problem with a fully-invested constraint as follows
$$
\begin{align*}
& \max _{A} \operatorname{Tr}\left(A \Sigma_{r x}\right)-\frac{\gamma}{2} \operatorname{Tr}\left(\Sigma_{x} A \Sigma_{r} A^{\prime}\right)  \tag{17}\\
& \text { subject to } \mathbf{1}^{\prime} A^{\prime} x_{t}=1,
\end{align*}
$$
where 1 denotes the conformable vector of ones of dimension $N$. The problem has the following analytical solution
$$
\begin{equation*}
w_{t}^{\mathrm{FI}}=(1-\kappa) \frac{\Sigma_{r}^{-1} \mathbf{1}}{\mathbf{1}^{\prime} \Sigma_{r}^{-1} \mathbf{1}}+\kappa \frac{\Sigma_{r}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} x_{t}}{\mathbf{1}^{\prime} \Sigma_{r}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} x_{t}}, \tag{18}
\end{equation*}
$$
where $\kappa:=\gamma^{-1} \mathbf{1}^{\prime} \Sigma_{r}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} x_{t}$ is a scalar value.
Proposition 3 shows that the portfolio weight is expressed as a convex linear combination of the global minimum variance portfolio and the optimal unconstrained portfolio policy that is renormalized to one. The latter portfolio resembles the so-called 'tangency portfolio', which is the highest Sharpe ratio of a portfolio of risky assets from the standard mean-variance framework. The fully-invested portfolio $w_{t}^{\mathrm{FI}}$ has a similar form to the one obtained from the standard Markowitz paradigm found in Merton (1972).

\subsection*{2.4 Relation to Existing Literature}

At this juncture, it is important to highlight the differences between our work from those of the existing literature. We first draw our attention to the fact that the objective function (5) under our consideration is similar to that of Brandt and Santa-Clara (2006). ${ }^{8}$ Suppose that the joint distribution of the returns and signals is Gaussian and the squared returns of the conditional managed portfolios are relatively small and can be approximately zero. We can express the optimal matrix of coefficients $A$ from Equation (6) in vectorized form as
$$
\begin{align*}
\operatorname{vec}(A) & =\frac{1}{\gamma} \operatorname{vec}\left(\Sigma_{x}^{-1} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1}\right)  \tag{19}\\
& =\frac{1}{\gamma}\left(\Sigma_{x}^{-1} \otimes \Sigma_{r}^{-1}\right) \operatorname{vec}\left(\Sigma_{r x}^{\prime}\right)  \tag{20}\\
& =\frac{1}{\gamma}\left(\Sigma_{x} \otimes \Sigma_{r}\right)^{-1} \operatorname{vec}\left(\Sigma_{r x}^{\prime}\right)  \tag{21}\\
& \approx \frac{1}{\gamma} \mathbb{E}\left[\left(x_{t} x_{t}^{\prime}\right) \otimes\left(r_{t+1} r_{t+1}^{\prime}\right)\right]^{-1} \mathbb{E}\left[x_{t} \otimes r_{t+1}\right] \tag{22}
\end{align*}
$$
where vec $(\cdot)$ is an operator that stacks the columns of matrix $A$ into a vector, and $\otimes$ is the Kronecker product of two matrices. The fourth (approximate) equality invokes our sparsity assumptions so that the second-moment matrix of the conditional product returns $x_{t} \otimes r_{t+1}$ is a Kronecker product of two covariances. This corresponds to the solution that one obtains by rewriting the portfolio returns as $x_{t}^{\prime} A r_{t+1}=\operatorname{vec}(A)\left(x_{t} \otimes r_{t+1}\right)$, and optimizing over vec $(A)$ with respect to $x_{t} \otimes r_{t+1}$.

\footnotetext{
${ }^{8} \mathrm{~A}$ subtle difference worth pointing out is that the authors model the portfolio policy to be affine in the state variables, and hence the allocations are also driven by the assets themselves. Here, we work in a slightly restricted setting where the portfolio policy is only driven by the conditional managed portfolios themselves.
}

The authors considered this new optimization scheme to be an augmented asset space form of the mean-variance optimization. They streamlined the forecasting and allocation process by combining them into a single step, effectively minimizing the potential for model misspecification and estimation error (Brandt, 1999). However, there are two issues with this approach. First, augmenting the asset space results in a severe expansion of the problem dimension. The unrestricted covariance matrix in (22) has $N^{2} M\left(N^{2} M+1\right) / 2$ parameters, while our Kronecker product factorization in (21) has only $N(N+1) / 2+N M(N M+1) / 2$ parameters. Clearly, the former becomes less computationally tractable when the dimensions of both the asset and signal space are large. Second, there is less clarity on the structure of their optimal solution due to the complicated interactions in the covariance between the subsequent returns and signals. Notwithstanding these shortcomings, our efforts in recasting the optimal strategy (22) into (6) (or (B.5) in Theorem 2) help to amend their approach towards large-scale financial applications. Although this requires us to model the joint distribution of returns and signals, our solution lends itself nicely to the study of the joint correlation structure of the optimal matrix of coefficients $A$, as we will demonstrate in Section 3.3.

Second, our work is related to the classic portfolio selection problem of Markowitz (1952) in its static form. If we assume independent and identically distributed (i.i.d.) returns with constant moments and time-invariant weights $w_{t} \equiv w$, the conditional portfolio problem (11) simplifies to an unconditional one, which has the following well-known solution
$$
\begin{equation*}
w=\frac{1}{\gamma} \operatorname{Var}\left[r_{t+1}\right]^{-1} \mathbb{E}\left[r_{t+1}\right] \tag{23}
\end{equation*}
$$

This portfolio policy is an unconditional strategy because it does not use any information today and is typically implemented through plug-in estimation. In this paper, we focus on the more realistic setting of non-i.i.d. returns, which motivates our model parameterization and use of conditioning variables that affect the joint distribution of returns.

Finally, our work is also related to Kelly et al. (2022) on cross-predictability. In their work, the authors pursued a similar parameterization for the portfolio weights but optimize an objective function that is subject to a robust risk constraint that controls for the leverage of $A$. As a result, their optimal portfolio policy depends only on the cross-covariance matrix. When viewed in the context of our framework, the analysis is simplified and avoids the challenges of inverting two additional large-dimensional matrices. However, this departs from our paper on two fronts. First, we assume that the investors have mean-variance preferences in a similar spirit to the standard mean-variance problem. ${ }^{9}$ Second, our application of canonical correlation analysis formally suggests that the cross-covariance between decorrelated asset returns and signals is the more appropriate object for investment analysis as opposed to the cross-covariance of the original asset returns and signals. This is because the latter contains non-trivial variations that are embedded in both financial variables that may obscure the inference.

\footnotetext{
${ }^{9}$ Levy and Markowitz (1979) and Markowitz (1991) argue that the mean-variance preferences serve as a reasonable approximation to other utility preferences in portfolio selection problems.
}

\section*{3 Strategy Diversification}

\subsection*{3.1 Canonical Correlation Analysis}

The goal of canonical correlation analysis (CCA) is to perform dimension reduction on two different data sets that comprise a large number of interrelated variables, while simultaneously retaining as much of the correlation present in the two data sets. This can be achieved through a transformation of the original set of variables into a new set of mutually orthogonal paired variables, which are ranked so that the largest few retain most of the correlation present in all of the original variables.

There are several standard approaches to solving the CCA problem as outlined in Uurtio et al. (2017). Indeed, this may involve solving a standard eigenvalue problem (Hotelling, 1936), or a singular value decomposition (SVD) (Healy, 1957), or through a generalized eigenvalue problem (Bach and Jordan, 2002). We adopt the SVD approach in this brief exposition of the classical subject by emphasizing a sequence of two change of basis operations to arrive at a reduced problem whose financial interpretation we provide in Section 3.3.

Given that scale invariance is a property of correlation, the first step is to orthogonalize the random vectors $r$ and $x$ such that their covariances are the identity matrices. This can be achieved through the following linear transformations $\tilde{r}:=\Sigma_{r}^{-1 / 2} r$ and $\tilde{x}:=\Sigma_{x}^{-1 / 2} x$. The transformed objects are now uncorrelated and have a unit variance and their joint covariance matrix is given by
$$
\left(\begin{array}{cc}
\mathbb{I}_{N} & \Sigma_{r}^{-1 / 2} \Sigma_{r x} \Sigma_{x}^{-1 / 2}  \tag{24}\\
\Sigma_{x}^{-1 / 2} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1 / 2} & \mathbb{I}_{N M}
\end{array}\right)
$$

It is helpful to introduce the object
$$
\begin{equation*}
\Sigma_{\tilde{r} \tilde{x}}:=\mathbb{E}\left[\tilde{r} \tilde{x}^{\prime}\right]=\Sigma_{r}^{-1 / 2} \Sigma_{r x} \Sigma_{x}^{-1 / 2} \tag{25}
\end{equation*}
$$
as the adjusted cross-correlation matrix between the transformed variables $\tilde{r}$ and $\tilde{x} .^{10}$
The second step is to perform an SVD operation on the adjusted cross-covariance matrix $\Sigma_{\tilde{r} \tilde{x} \tilde{x}}$. Let $\left(\left(s_{1}, \ldots, s_{N}\right) ;\left(u_{1}, \ldots, u_{N}\right) ;\left(v_{1}, \ldots, v_{N}\right)\right)$ denote a system of singular values and singular vectors of the adjusted cross-covariance matrix $\Sigma_{\tilde{r} \tilde{x}}$. We assume that the singular values $s_{i}$ are sorted in increasing order. The canonical correlations correspond to the singular values. The canonical variates of $r$ and $x$ are defined as $u_{1}^{\prime} \tilde{r}, \ldots, u_{N}^{\prime} \tilde{r}$ and $v_{1}^{\prime} \tilde{x}, \ldots, v_{N}^{\prime} \tilde{x}$, respectively. As the singular values, $s_{i}$ are sorted in increasing order, the canonical variate with the largest correlation is given by the pair $\left(u_{N}^{\prime} \tilde{r}, v_{N}^{\prime} \tilde{x}\right)$ while the canonical variate with the smallest correlation is $\left(u_{1}^{\prime} \tilde{r}, v_{1}^{\prime} \tilde{x}\right)$.

Finally, since the solutions are expressed on a different basis than our original problem, we have to translate them back to our original basis. By inverting the change of variables we made, the $i$ th canonical variates can be written as $\left(u_{i}^{\prime} \Sigma_{r}^{-1 / 2} r, v_{i}^{\prime} \Sigma_{x}^{-1 / 2} x\right)$. This pair can be seen as a linear combination of the original assets and signals with coefficients given by $q_{r, i}:=\Sigma_{r}^{-1 / 2} u_{i}$ and $q_{x, i}:=\Sigma_{x}^{-1 / 2} v_{i}$, which are the so-called canonical directions. The application of change of basis operations simplifies the covariance structure considerably.

In order to implement the CCA in practice, a common approach is to replace the population second-moments $\Sigma_{r}, \Sigma_{x}$, and $\Sigma_{r x}$, with their sample counterparts $S_{r}, S_{x}$, and $S_{r x}$ computed from random samples $r_{1}, \ldots, r_{T}$ and $x_{0}, \ldots, x_{T-1}$. Let $\left(\left(\hat{s}_{1}, \ldots, \hat{s}_{N}\right) ;\left(\hat{u}_{1}, \ldots, \hat{u}_{N}\right) ;\left(\hat{v}_{1}, \ldots, \hat{v}_{N}\right)\right)$ be a system of singular values (sorted in increasing order) and singular vectors of the sample analog of (25) denoted by $S_{\tilde{r} \tilde{x}}$. Then the sample canonical variates of $r$ and $x$ are given by $\hat{u}_{1}^{\prime} \tilde{r}, \ldots, \hat{u}_{N}^{\prime} \tilde{r}$ and $\hat{v}_{1}^{\prime} \tilde{x}, \ldots, \hat{v}_{N}^{\prime} \tilde{x}$, respectively. However, one should be skeptical of sample canonical correlations as they are not reflective of the population canonical correlations. Indeed, the true canonical correlation of the $i$ th canonical variate pair $\left(\hat{u}_{i}^{\prime} \tilde{r}, \hat{v}_{i}^{\prime} \tilde{x}\right)$ is $\hat{v}_{i}^{\prime} \Sigma_{\tilde{r} \tilde{x}}^{\prime} \hat{u}_{i}$, as opposed to $\hat{s}_{i}=\hat{v}_{i}^{\prime} S_{\tilde{r} \tilde{x}}^{\prime} \hat{u}_{i}$. This is because the sample canonical correlations are known to be inconsistent estimates of their population counterparts when the dimensionality of the problem for both variables is large relative to the number of observations.

\footnotetext{
${ }^{10}$ Note that the matrix (25) is different from the unadjusted cross-covariance matrix $\Sigma_{r x}$. The adjusted crosscovariance matrix is the central object in CCA as it internalizes the variabilities from the asset returns and signals that might potentially obscure the relationships between both of the variables. Moreover, since the optimal matrix of coefficients for our problem (5) is indeed the adjusted cross-covariance matrix under an appropriate change of basis (see Section 3.3), it makes sense for us to focus on this object for our analysis.
}

To bring this point home, let us consider a specific case when the two variable sets $r$ and $x$ are independent and each set consists of i.i.d. Gaussian random variables. Figure 1 shows the distribution of sample canonical correlations for various values of the limiting ratios $N / T \in\{0.003,0.03,0.3\}$ and $M / T \in\{0.006,0.06,0.6\}$. We obtained this figure by invoking the asymptotic formula derived by Wachter (1980, Theorem 3.1). ${ }^{11}$ We observe that the sample canonical correlations are biased upwards away from zero and the severity of the bias worsens as $N / T$ or $M / T$ or both increases. This distributional shape is expected to hold when $N, M$, and $T$ are approximately large and it only depends on the ratio $N / T$ and $M / T$; this is true regardless of any particular realization of the adjusted sample cross-covariance matrix. We attempt to address these problems with regularization in Section 3.6.

\footnotetext{
${ }^{11}$ Wachter's result also holds under a less restrictive setting of i.i.d. data with finite second-moments; see Yang and Pan (2012, Theorem 1).
}

\subsection*{3.2 Relation to PCA, PLS, and RRR}

Having laid the groundwork for CCA, it is interesting to explore the relationship between CCA and a variety of linear dimension-reduction techniques that are commonly employed to reveal underlying economic structures. We shall restrict our attention to the principal component analysis (PCA), partial least squares (PLS), and reduced rank regression (RRR) due to their tight connection with one another and extensive applications in the finance and econometrics literature.

PCA, for instance, has been used to extract common factors from a covariance matrix of individual stocks among others by Roll and Ross (1980), Connor and Korajczyk $(1986,1988)$, and Lehmann and Modest (1988). In the context of describing risk compensation through estimation of the stochastic discount factor, Kozak et al. $(2018,2020)$ invokes no near-arbitrage arguments for the use of PCA to identify factor risk exposures that price the cross-section of expected returns of characteristic-managed portfolios. For PLS, one of the earliest applications to finance can be ascribed to Kelly and Pruitt (2013), where the authors used a three-pass regression filter (which is a special case of PLS) to forecast market return and cash flow growth. The RRR, alongside CCA, features prominently in the estimation of the celebrated vector-error-correction model (VECM) of Engle and Granger (1987) as a means to detect cointegration, which are economic relationships that cannot be obtained through standard regression approaches; see Johansen (1988, 1991, 1995).

Starting with PCA developed by Hotelling (1933), the method seeks to break down the variation of the data into mutually orthogonal components whose variances can be ranked from the smallest to the largest. In the context of a paired dataset consisting of asset returns with their associated signals, PCA focuses on searching for directional vectors that have the maximum variation in each variable separately. In contrast to CCA, however, it does not take into account any relationship between the two financial variables. In this paper, we would like to focus on how financial variables are related, not how much they vary. We summarize the key properties distinguishing PCA and CCA in Table 1.

On the other hand, PLS was introduced by Wold (1975) as an econometric technique that aims to explain the relationship of a paired dataset by studying the (cross-)covariance. This can be understood by relaxing the variance constraints in the optimization problem of CCA, which results in a maximum (cross-)covariance problem. The solution(s) can be obtained via singular value decomposition of the cross-covariance matrix, $\Sigma_{r x}$, and the corresponding managed portfolios closely mimic that of Kelly et al. (2022). This differs from CCA where the cross-covariance matrix is normalized with respect to the covariances from both the $r_{t+1}$ and the $x_{t}$ variables.

Finally, the RRR proposed by Anderson and Rubin $(1949,1950)$ and Anderson (1951) can be understood through the regression framework (13) with the following error minimization problem:
$$
\begin{equation*}
\min _{B} \mathbb{E}\left[\left\|\Gamma^{1 / 2}\left(r_{t+1}-B^{\prime} x_{t}\right)\right\|_{2}^{2}\right] \tag{26}
\end{equation*}
$$
where $\Gamma$ is a $N \times N$ weighting matrix, and the matrix $B$ is subject to a rank constraint; see also, Velu and Reinsel (2013). Expressing the objective function in terms of the unconditional moments, we have
$$
\begin{align*}
\mathbb{E}\left[\left\|\Gamma^{1 / 2}\left(r_{t+1}-B^{\prime} x_{t}\right)\right\|_{2}^{2}\right] & =\mathbb{E}\left[\left\|\Gamma^{1 / 2} r_{t+1}\right\|_{2}^{2}\right]-2 \mathbb{E}\left[x_{t}^{\prime} B \Gamma r_{t+1}\right]+\mathbb{E}\left[x_{t}^{\prime} B \Gamma B^{\prime} x_{t}\right]  \tag{27}\\
& =N-2 \operatorname{Tr}\left(B \Gamma \Sigma_{r x}\right)+\operatorname{Tr}\left(B \Gamma B^{\prime} \Sigma_{x}\right)  \tag{28}\\
& =\left\|\Gamma^{1 / 2} B \Sigma_{x}^{1 / 2}-\Gamma^{1 / 2} \Sigma_{r x} \Sigma_{x}^{-1 / 2}\right\|_{\mathrm{F}}^{2}+\text { constant. } \tag{29}
\end{align*}
$$

The solution to this rank-restricted minimization problem follows from the theorem of Eckart and Young (1936) and it relies on the singular value decomposition of $\Gamma^{1 / 2} \Sigma_{r x} \Sigma_{x}^{-1 / 2}$. The typical objective function of RRR occurs when $\Gamma=\mathbb{I}_{N}$. If additionally, $\Sigma_{x}=\mathbb{I}_{M}$, then RRR coincides with PLS. Finally, observe that if $\Gamma=\mathbb{I}_{N}$ and $r_{t+1}=x_{t}$, then the objective function coincides with that of PCA.

Interestingly, if $\Gamma=\Sigma_{r}^{-1}$, then the solution of RRR generalizes to CCA. This speaks to the difference between optimizing a regression-based objective and a correlation-based objective. Indeed, regression attempts to explain as much of the variation in the returns $r_{t+1}$ as possible. However, if $r_{t+1}$ is decorrelated and isotropic along all variance directions, then minimizing a regression loss function becomes equivalent to maximizing a correlation objective. Unlike conventional regressionbased approaches, there is no notion of independent and dependent variables in CCA because the correlation metric is symmetric; that is, if we exchange the roles of asset returns and signals, CCA yields identical outcomes for the canonical directions and canonical correlations.

In summary, RRR, PLS, and CCA can all be viewed under the same framework, which is solving a cross-covariance maximization problem. Each of these linear dimensional reduction techniques is subject to different normalization schemes with CCA serving as the most general one that nests these methods.

\subsection*{3.3 Reformulation as Canonical Portfolios}

The portfolio returns obtained with (6) is not particularly intuitive as the expression involves large-dimensional matrix inversion and multiplication operations. However, we can make progress by performing a CCA in order to decompose the portfolio selection problem into one that we can provide financial interpretation.

We start by expressing the portfolio returns in terms of their transformed objects as
$$
\begin{equation*}
x_{t}^{\prime} A r_{t+1}=\frac{1}{\gamma} x_{t}^{\prime} \Sigma_{x}^{-1} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1} r_{t+1}=\frac{1}{\gamma} \tilde{x}_{t}^{\prime} \Sigma_{\tilde{r} \tilde{x}} \tilde{r}_{t+1} \tag{30}
\end{equation*}
$$

Since the decorrelated objects $\tilde{r}_{t+1}$ and $\tilde{x}_{t}$ span the same universe as the original assets and signals, we shall term them 'synthetic assets' and 'synthetic signals'. These newly defined objects have identity covariances, and so this is the cross-sectional version of risk parity.

From expression (30), we can see that the portfolio returns depend intricately on the synthetic asset returns and synthetic signals, which are coupled through their adjusted cross-covariances. The portfolio returns do not depend on whether we exchange the role of the asset returns of signals; what matters is how they are related to each other.

Our next step is to choose basis vectors such that $\Sigma_{\tilde{r} \tilde{x}}$ is diagonal. In particular, we perform an SVD operation such that all cross-relationships are eliminated in the new basis in order to arrive at the following simplified expression for the portfolio returns:
$$
\begin{equation*}
x_{t}^{\prime} A r_{t+1}=\frac{1}{\gamma} \sum_{i=1}^{N} s_{i}\left(v_{i}^{\prime} \tilde{x}_{t}\right)\left(u_{i}^{\prime} \tilde{r}_{t+1}\right) \tag{31}
\end{equation*}
$$

Thus, we see that a generic strategy return can be viewed either as a combination of the original assets and signals that have been optimally blended with the matrix of coefficients $A$, or as a combination of $N$ uncorrelated managed long-short portfolios weighted by their canonical correlations. The $N$ long-short managed portfolios span the same space of investment opportunities as the original assets and signals.

Economically, we interpret the change of basis as an operation that reorganizes the set of $N$ synthetic assets and $N$ synthetic signals into a set of $N$ uncorrelated managed portfolios. Each of these managed portfolios is expressed as a certain weighted combination of the assets and signals themselves. These particular combinations are determined by the singular vectors or canonical directions; in either case, we shall refer to them as canonical portfolios henceforth to reinforce the idea that these vectors are essentially managed portfolios that are loading onto their respective asset and signal variables. The higher the $i$ th canonical correlation, the higher the return of the $i$ th canonical portfolio. Said differently, the canonical portfolios are ordered in such a way that the highest canonical correlation corresponds to the most linearly predictable portfolio, and the second highest canonical correlation, the second most linearly predictable portfolio, and so on. This notion of predictability distinguishes canonical portfolios from other concepts of orthogonal managed portfolios such as those constructed by PCA.

Circling back to Equation (31), the source of the portfolio returns can be seen to be distributed across the canonical portfolios of $\Sigma_{\tilde{r} \tilde{x}}$. This reinforces the economic notion of diversification: Having exposure to different uncorrelated canonical portfolios is akin to putting each of your eggs into different baskets. We see that the capital assigned to each canonical portfolio is proportional to its original returns $r_{t+1}$ and signal $x_{t}$, and proportional to the correlation $s_{i}$. Put differently, we want to assign capital to managed portfolios that have high correlations but are also orthogonal to each other.

\subsection*{3.4 Canonical Portfolio Analysis}

With our CCA decomposition, we can also gain some insight into how the canonical portfolios impact the returns of a portfolio. We start by working out the expected returns and variance of these canonical portfolios with the next proposition.

Proposition 4. Let $\pi_{t, i}:=s_{i}\left(v_{i}^{\prime} \tilde{x}_{t}\right)\left(u_{i}^{\prime} \tilde{r}_{t+1}\right)$ be the return that the $i$ th canonical portfolio generates. The expected value and variance return of each canonical portfolio are
$$
\begin{equation*}
\mathbb{E}\left[\pi_{t, i}\right]=s_{i}^{2}, \quad \text { and } \quad \operatorname{Var}\left[\pi_{t, i}\right]=s_{i}^{2}\left(1+s_{i}^{2}\right) \tag{32}
\end{equation*}
$$

Furthermore, the expected value of the optimal portfolio returns and its squared returns are given by
$$
\begin{equation*}
\mathbb{E}\left[x_{t}^{\prime} A r_{t+1}\right]=\frac{1}{\gamma} \sum_{i=1}^{N} s_{i}^{2}, \quad \text { and } \quad \mathbb{E}\left[x_{t}^{\prime} A \Sigma_{r} A^{\prime} x_{t}\right]=\frac{1}{\gamma^{2}} \sum_{i=1}^{N} s_{i}^{2} \tag{33}
\end{equation*}
$$

We see that the expected portfolio returns are positive, and hence, the optimal portfolio is a profit-generating strategy that has economic value. Moreover, the expected portfolio returns can be expressed as the sum of the contributions from the squared canonical correlations; the larger the expected return of the $i$ th canonical portfolio, the larger its contribution towards the overall returns. ${ }^{12}$ This suggests that the squared canonical correlations can serve as a natural measure to rank the performance of the canonical portfolios.

\footnotetext{
${ }^{12}$ The formulas (32) and (33) have some close similarities to a result in Kelly et al. (2022, Proposition 4) for the expected returns. One notable difference, however, is that our singular values are raised to the power of two. This is implicit in the fact that the expected return of each canonical portfolio is scaled by a leverage factor of $s_{i}$. On the other hand, this multiplicative factor is absent in their expression since leverage is explicitly controlled for in their problem formulation.
}

Interestingly, the canonical correlations are also intimately connected to the Sharpe ratio of the returns associated with our portfolio policy.

Corollary 1. The Sharpe ratio of the $i$ th canonical portfolio and the optimal portfolio is given by
$$
\begin{equation*}
\mathrm{SR}_{i}:=\frac{\mathbb{E}\left[\pi_{t, i}\right]}{\sqrt{\operatorname{Var}\left[\pi_{t, i}\right]}}=\frac{s_{i}}{\sqrt{1+s_{i}^{2}}}, \quad \text { and } \quad \mathrm{SR}:=\frac{\mathbb{E}\left[x_{t}^{\prime} A r_{t+1}\right]}{\sqrt{\mathbb{E}\left[x_{t}^{\prime} A \Sigma_{r} A^{\prime} x_{t}\right]}}=\sqrt{\sum_{i=1}^{N} s_{i}^{2}} \tag{34}
\end{equation*}
$$

From Corollary 1, we see the squared canonical correlations also influence the portfolio's Sharpe ratio. We end this section with two simple examples to give further intuition into these results.

Example 3 (Equal canonical correlations). If we suppose $s_{i}=s$ for all $i$, then Equation (34) simplifies to $\mathrm{SR}=s \sqrt{N}$. In this special case, we arrive at the Fundamental Law of Active Management of Grinold (1989), where the so-called 'information coefficient' is $s$ and the effective number of statistically independent investments (also referred to as 'breadth') is $N$. We see that the Sharpe ratio improves with the average canonical correlation and the number of canonical portfolios, with the latter exhibiting diminishing gains to returns due to the square-root scaling in its exponent. In the general case where the canonical correlations are not identical across all canonical portfolios, the canonical correlations are thought to be the information coefficient over clusters of signals. ${ }^{13}$

Example 4 (Bias of In-Sample Returns). Let $\hat{A}:=\gamma^{-1} S_{x}^{-1} S_{r x}^{\prime} S_{r}^{-1}$ is the optimal matrix of coefficients that replaces the population moments in $A$ with sample moment-based estimates. For simplicity, suppose that $S_{r}=\Sigma_{r}$ and $S_{x}=\Sigma_{x}$. Since the Frobenius norm is a convex function, by Jensen's inequality, the expected portfolio return satisfies
$$
\begin{equation*}
\mathbb{E}\left[\operatorname{Tr}\left(\hat{A} S_{r x}\right)\right]=\frac{1}{\gamma} \mathbb{E}\left[\operatorname{Tr}\left(S_{\tilde{r} \tilde{x}}^{\prime} S_{\tilde{r} \tilde{x}}\right)\right] \geq \frac{1}{\gamma} \operatorname{Tr}\left(\mathbb{E}\left[S_{\tilde{r} \tilde{x}}\right]^{\prime} \mathbb{E}\left[S_{\tilde{r} \tilde{x} \tilde{x}}\right)=\frac{1}{\gamma} \mathbb{E}\left[\operatorname{Tr}\left(S_{\tilde{r} \tilde{x}}^{\prime} \Sigma_{\tilde{r} \tilde{x}}\right)\right]\right. \tag{35}
\end{equation*}
$$
where we used the fact that $\mathbb{E}\left[S_{r x}\right]=\Sigma_{r x}$ in the last equality due to the unbiasedness of the sample cross-covariance. Hence,
$$
\begin{equation*}
\sum_{i=1}^{N} \mathbb{E}\left[\hat{s}_{i}^{2}\right] \geq \sum_{i=1}^{N} s_{i}^{2}=\sum_{i=1}^{N} \mathbb{E}\left[\hat{s}_{i} s_{i}^{\circ}\right] \tag{36}
\end{equation*}
$$
where $s_{i}^{\circ}:=\hat{q}_{r, i}^{\prime} \Sigma_{r x} \hat{q}_{x, i}$ is the out-of-sample 'canonical correlation' associated with the $i$ th estimated canonical portfolio $\hat{q}_{r, i}$ and $\hat{q}_{x, i} .{ }^{14}$ Hence, on average, the in-sample returns are always optimistic but the out-of-sample evaluation disappoints. This is because both the in-sample singular values and singular vectors are estimated with a bias. Hence, in order to ensure that the in-sample and out-of-sample returns are more in sync, we have to shrink the in-sample singular values and align singular vectors closer to the truth.

\footnotetext{
${ }^{13}$ We thank Attilio Meucci for this insight.
${ }^{14}$ In fact, a more precise relationship between the in-sample and out-of-sample portfolio returns have been established by Benaych-Georges et al. (2023, Proposition 2.9).
}

\subsection*{3.5 Static and Dynamic Returns Decomposition}

In our standing assumptions, we supposed that both the asset returns and signals are centered and have zero means. However, when evaluating the out-of-sample performance of the portfolio, the original non-demeaned returns and signals tend to be used instead. Moreover, the means of both financial variables may be non-negligible and contain useful information for describing the crosspredictability of future returns. In general, we can write the second-moment matrix of conditional portfolios using the following decomposition:
$$
\begin{equation*}
\Sigma_{r x}=\mathbb{E}\left[r_{t+1} x_{t}^{\prime}\right]=\mathbb{E}\left[r_{t+1}\right] \mathbb{E}\left[x_{t}\right]^{\prime}+\operatorname{Cov}\left(r_{t+1}, x_{t}\right) \tag{37}
\end{equation*}
$$

The first component is a rank-one outer product matrix of the unconditional means in the asset returns and signals while the second component is the cross-covariance matrix of the demeaned returns and signals. In particular, the first component places emphasis on the cross-sectional differences driven by the unconditional levels since all time-series variabilities have been averaged out, while the second component captures time-series variations in the returns and signals that are expressed as the deviations from their unconditional means. Kelly et al. (2022) describe the first component as static bets and the second component as dynamic bets.

We can derive the expected returns of the optimal portfolio in this setting in the next proposition.
Proposition 5. If the expected value of the returns and signals are $\mathbb{E}\left[r_{t+1}\right]=\mu_{r}$ and $\mathbb{E}\left[x_{t}\right]=\mu_{x}$, then the expected return of a portfolio utilizing the second-moment matrix (37) is given by
$$
\begin{equation*}
\mathbb{E}\left[x_{t}^{\prime} A r_{t+1}\right]=\frac{1}{\gamma}\left(\mu_{r}^{\prime} \Sigma_{r}^{-1} \mu_{r}\right)\left(\mu_{x}^{\prime} \Sigma_{x}^{-1} \mu_{x}\right)+\frac{1}{\gamma} \sum_{i=1}^{N} s_{i}^{2} \tag{38}
\end{equation*}
$$

Proposition 5 shows that there is an additional non-negative contribution to the portfolio returns, which is due to the (squared) maximum Sharpe ratio achievable from the assets. This observation aligns nicely with our interpretation that the sum of the squared canonical correlations is related to the squared Sharpe ratio of optimal portfolio returns from Corollary 1. That is, the expected portfolio returns can be attributed to the Sharpe ratios from both static and dynamic bets.

We shall let our portfolio exploit both investment opportunities that arise from the secondmoment matrix of managed portfolio returns. This is possible within our framework since the assumption of zero-mean returns and signals strictly applies to the variance of the portfolio returns, and so only the covariances of the returns and signals have to be centered. However, we shall apply CCA to the cross-covariance matrix to fulfill its modeling assumptions since otherwise, it can result in a generic top canonical portfolio that is mainly driven by the unconditional levels. ${ }^{15}$

\footnotetext{
${ }^{15} \mathrm{CCA}$ is sometimes applied to non-demeaned variables. In such a case, this is more closely related to using a cosine similarity objective instead of a correlation objective.
}

\subsection*{3.6 Estimation}

Our optimal portfolio policy requires the knowledge of the population covariances of the asset returns, the covariances of the signals, and cross-covariance between both variables. These objects are generally unknown to us, and so in order to render our framework to practice, we have to estimate them with real data. Given the large-dimensional nature of our problem, it is necessary to regularize the covariances of our portfolio to reduce the estimation errors. Unfortunately, simply maintaining the top canonical portfolio is not sufficient for empirical analysis. Indeed, if either the assets or the signals have rank $T$ (which tends to be the case when $N \gg T$ ), then the canonical portfolios can take on any arbitrary values. Moreover, since the smallest amount of variability in each dataset gets rescaled to one, CCA can produce spurious outcomes.

The challenge of estimating the covariance matrix of financial covariances is well known amongst practitioners (Jobson and Korkie, 1980). A standard approach is to use the sample covariance matrix. However, when the dimensionality of the problem is large relative to the number of observations, estimation error of the sample covariance matrix can create issues for portfolio optimizers; they tend to place extreme bets on low-risk sample eigenvectors. In fact, this observation led Michaud (1989) to refer to mean-variance optimizers as 'error maximization' schemes. There have been several approaches from practice to address this problem using methods from bootstrapping (Michaud and Michaud, 2008) to Bayesian estimators (Black and Litterman, 1992; Lai et al., 2011).

We obtain regularized covariance matrices by applying the linear shrinkage technology from Ledoit and $\operatorname{Wolf}(2004 \mathrm{~b})$. The covariances of returns will be estimated as $\hat{\Sigma}_{r}=\left(1-\delta_{r}\right) S_{r}+\delta_{r} N^{-1} \operatorname{Tr}\left(S_{r}\right) \mathbb{I}_{N}$, where the shrinkage intensity $\delta_{r}$ is determined based on an asymptotic formula. We also apply the same linear shrinkage technology for the covariances of signals $\hat{\Sigma}_{x}$ with a shrinkage intensity parameter $\delta_{x}$. The choice of linear shrinkage of the covariances has a nice interpretation in our context in that varying the shrinkage intensities allows us to interpolate between the maximum covariance (PLS) and maximum correlation (CCA) problems. Shrinking towards maximum covariance helps to break the singularities by considering managed canonical portfolios that have better out-of-sample properties. In the extreme regularization setting with both $\hat{\Sigma}_{r}$ and $\hat{\Sigma}_{x}$ being identity matrices, our estimated canonical portfolios mimics the principal portfolios approach of Kelly et al. (2022).

With both of these estimated covariances at hand, we proceed to build a regularized adjusted cross-covariance matrix by pre-conditioning the sample covariances $S_{r x}$ on both sides with the estimated matrix factors $\hat{\Sigma}_{r}^{1 / 2}$ and $\hat{\Sigma}_{x}^{1 / 2}$. One can then choose to maintain the top few canonical correlations of the regularized adjusted sample cross-covariance matrix defined as
$$
\begin{equation*}
\hat{\Sigma}_{r}^{-1 / 2} S_{r x} \hat{\Sigma}_{x}^{-1 / 2} \tag{39}
\end{equation*}
$$
and set the bottom ones to zero. ${ }^{16}$ This thresholding operation has the effect of regularizing the problem as it reduces the effective number of parameters that we have to estimate by maintaining the top few canonical portfolios that are the most predictable.

\footnotetext{
${ }^{16}$ The regularized sample adjusted cross-covariance matrix (39) has a close similarity to that of Vinod (1976), where ridge regression was proposed as a means of regularizing the sample adjusted cross-covariance matrix. We resort to the class of linear shrinkage estimators due to their ability to also reduce the influence of large variance directions.
}

\section*{4 Empirical Analysis}

\subsection*{4.1 Data and Portfolio Construction Rules}

For our empirical analysis, we download six datasets from Kenneth French's data library, which are characteristic-sorted long-short stock portfolios. ${ }^{17}$ They are daily returns on portfolios of stocks sorted on the basis of size and book-to-market (FF), size and operating profitability (ME/OP), and size and investment (ME/INV), each of which is of universe size 25 and 100. In comparison to individual stocks, each return of a portfolio is an average return of a group of stocks sharing similar characteristics and so they are less subject to large variabilities due to idiosyncratic risks. Hence, they serve as useful test assets that may allow us to easily harvest the predictability in stock returns.

\footnotetext{
${ }^{17}$ The description of all portfolio construction can be found on Kenneth French's website: https://mba.tuck. dartmouth.edu/pages/faculty/ken.french/data_library.html. At the time of writing, these datasets were based on the 10-2022 CRSP database.
}

Although some of these portfolio returns have been available since 1926, we conduct most of our analysis on the period from July 1963 to October 2022, for which most of the returns are available. For simplicity, we suppose that 21 consecutive days constitute one trading 'month' and 252 consecutive days as one trading 'year'. We adopt a sequential updating scheme and rebalance the portfolio every 'month' on a rolling walk-forward basis. To obtain a well-defined investment universe for which we can estimate the portfolios, we use the following rule. For each rebalancing date, we select test assets that have a complete return history over the most recent $T=120$ months as well as a complete return 'future' over the subsequent trading month. The backward and forward restrictions ensure that we have data to estimate our models and to evaluate out-of-sample. This provides us with 578 monthly out-of-sample returns, which covers the out-of-sample investment period from 09-09-1974 through 10-21-2022.

\subsection*{4.2 Signal Construction}

As a demonstration of our method for a dynamic portfolio selection problem between equity-sorted portfolios, we start with a single conditioning variable as our signal. We consider the momentum signal as there is substantial empirical evidence that documents this anomaly in the returns of individual stocks (Jegadeesh, 1990; Jegadeesh and Titman, 1993), industries (Moskowitz and Grinblatt, 1999), and of size and value portfolios (Lewellen et al., 2010). This application is similar to Kelly et al. (2022) for reproducibility.

To construct a momentum signal, we compute for each asset the lagged one-month return defined as the simple average return over the previous 21 trading days. Similar to Asness et al. (2019), Freyberger et al. (2020), Kozak et al. (2020) and Kelly et al. (2022), we rank the momentum signals across the assets from 1 to $N$, dividing the ranks by the number of assets, and then centering the normalized ranks to map the signals into the range $[-0.5,0.5]$. This provides us with a set of dollar-neutral signals that are insensitive to outliers for which we further divide by the sum of their absolute values. This keeps the gross exposure (that is, the sum of the absolute amount of long and short positions) fixed since otherwise doubling the number of assets at any time $t$ will result in signals that are two times more aggressive even though the investment opportunities remain the same. We assume $\$ 1$ of capital is invested to $\$ 1$ of long and short positions.

We collect the individual momentum values of the $N$ assets to yield a predictive signal $x_{t}$ for the subsequent monthly returns. Additionally, we impose a one-day buffer between the constructed signals and the subsequent returns to limit the effects of illiquidity from driving our results and to bring our backtest simulations closer to being tradeable practice. ${ }^{18}$

\footnotetext{
${ }^{18}$ The challenge working with the equity portfolios from Kenneth French's website is that they contain small illiquid stocks. Moreover, given that we are using daily returns, which are close-to-close returns, asynchronous trading at the end of the day may arise; see, for example, Lo and MacKinlay (1990). Consequently, this may induce some lead-lag relationships among the stocks, which can lead to autocorrelation in the portfolio returns and spurious correlation estimates due to the Epps (1979) effect. The latter problem can be particularly acute given our use of multivariate techniques in the estimation of portfolios. Therefore, we employ a one-day buffer along with monthly returns to mitigate the effects that asynchronous or infrequent trading can have on the portfolio returns.
}

\subsection*{4.3 Candidate Portfolios}

Given the time series panels of asset returns and signals, we consider the following portfolios in our study:
- CP2: Our proposed portfolio contruction methodology based on Equation (7).
- MVO: The mean-variance optimization portfolio of Markowitz (1952).
- PP2: The Principal Portfolios of Kelly et al. (2022).
- UNI: The univariate factor where the weights are the signals.

The competing portfolios have been chosen because they can be subsumed in our proposed method and hence, serve as natural benchmarks for us to determine where the contribution to any improved performance comes from. The suffix number attached to the portfolio labels CP and PP indicates the number of managed portfolios that we retain; for example, CP2 means that we choose to keep the leading two most predictable managed portfolios. ${ }^{19}$

The covariance of returns in CP2 and MVO is estimated with the linear shrinkage of Ledoit and Wolf (2004b). Additionally, we also apply linear shrinkage to the covariance of signals for CP2 but choose a high shrinkage intensity with value $\delta_{x}=0.9$ without relying on the asymptotic formula from Ledoit and Wolf (2004b) for this purpose since it was developed for financial returns that are assumed to be independent and identically distributed.

Finally, we renormalize the estimated portfolios so that the sum of the absolute value of their weights equals one. This allows all the portfolios to be comparable in scale. It also implies that the gross exposure for all portfolios is one dollar by construction, that is, we apply one dollar of capital for one dollar of long and short positions. This is sensible for long-short equity hedge fund managers who face institutional constraints such as limits on gross exposure by their prime brokerage. ${ }^{20}$

\footnotetext{
${ }^{20}$ The insights are similar if we renormalize the portfolios to achieve a target level of volatility or return.
}

\subsection*{4.4 Evaluation Methodology}

To evaluate the performance of the different portfolios, we report three main out-of-sample performance measures: the average cumulative out-of-sample returns, the standard deviation of the out-of-sample returns, and the Sharpe ratio defined as the ratio of the average returns to the standard deviation of returns. For ease of interpretability, all performance measures are annualized with 12 trading 'months'. The Sharpe ratio is computed with respect to the actual returns (as opposed to returns in excess of the risk-free rate) since we believe it is more relevant in our context where the portfolios are formed solely on the basis of risky assets.

We also report three additional performance measures based on the out-of-sample returns in excess of a 6-factor benchmark; that is, the 5 factors from Fama and French (2015) augmented with out-of-sample returns from UNI. We compute the Jensen's alpha, beta to the out-of-sample UNI returns, and information ratio from a 6 -factor regression model. This is done for all portfolios except for UNI. The alpha and information ratio are annualized with 12 trading 'months'. We also provide the t-statistics of the Sharpe ratio and information ratio, which are computed with approximate standard errors from Lo (2002).

Additionally, we report the following portfolio weight statistics averaged over the 578 trading months: turnover, proportional leverage (computed as the fraction of negative weights), the sum of negative weights, and the minimum and maximum weight. Note that these statistics are not our primary focus since our proposed method is not optimized to account for these measures. Nevertheless, they are provided to give a better overview of the different methods.

\subsection*{4.5 Application of Canonical Portfolio Analysis}

We can use the results of Proposition 4 to identify the sources of portfolio returns by estimating the canonical portfolios that contribute most to its profitability. To this end, we will consider the FF25, ME/OP25, and ME/INV25 test assets for this purpose. The FF25 is widely studied amongst academics and it allows us to check if our method produces the expected results. Moreover, we know from Lewellen et al. (2010) that the size and value portfolio returns have a strong factor structure explained mostly by the three-factor model Fama and French (1993). Kozak et al. (2018) finds that retaining the first three principal components extracted from FF25 closely reproduces the Fama and French three-factor model. Thus, this observation could potentially be exploited in our method.

The left panels of Figure 3 show the squared sample canonical correlations of the demeaned conditional portfolios matrix for the three test assets. It is also overlaid with the squared canonical correlations generated from randomly permuting the signals observations for each asset and repeating a similar exercise. ${ }^{21}$ The squared canonical correlations are averaged over the rebalancing dates and ordered from the smallest to the largest. From this in-sample analysis, we can see that the leading two squared sample canonical correlations have values larger than their pseudo-random generated counterparts and that the top one 'sticks out' and extends beyond the value of one. ${ }^{22}$ Moreover, the spacing between the sample canonical correlations is wider at the top end of the spectrum and more uniform at the bottom end of the spectrum.

\footnotetext{
${ }^{21}$ Randomly shuffling the time series helps generate a null distribution. It is a useful heuristic to determine the importance of each canonical correlation relative to a random benchmark compared to a formal statistical test of significance from Yang and Pan (2015).
${ }^{22}$ The values of (squared) regularized canonical correlations can exceed one unlike its sample-based analog, which is constrained to the interval $(0,1)$.
}

We contrast these findings with the right panels of Figure 3, which shows the out-of-sample returns of each canonical portfolio computed as the product of the in-sample and out-of-sample canonical correlation, accompanied by their standard error. Not surprisingly, we find a performance deterioration in the out-of-sample performance due to the bias in the in-sample predictions. Nevertheless, there is some coherence between the in-sample predictions and the out-of-sample returns in that the top canonical portfolio possesses the most realized returns followed by the second one, while the bottom ones are close to zero.

Given the prominence of the leading canonical correlation, we plot its corresponding weights. The left panels of Figure 4 show the top canonical portfolios (that is, the canonical directions) averaged over the rebalancing dates. To ensure the signs of the canonical portfolios are consistent across time, we flip the sign of the canonical portfolios at any given rebalancing date if its cosine similarity with the canonical portfolios obtained from the previous rebalancing date is negative. While there is not any clear pattern of trades that we can immediately discern, it nonetheless differs from other research findings vis--vis PCA; for example, Kelly et al. (2022) finds that the top principal component of a symmetrized cross-covariance matrix goes long (short) on big (small) equity portfolios, and long (short) on value (growth) portfolios. The right panels of Figure 4 provide the final weights invested in each asset.

\subsection*{4.6 Empirical Results}

Table 2 summarizes the performance of the various portfolio methods for the different test assets. Restricting our attention to the FF25 column, we see that CP2 has an average return, which is lower than that of PP2 ( $2.20 \%$ versus $3.76 \%$ ) but has much lower volatility ( $2.18 \%$ versus $5.85 \%$ ). ${ }^{23}$ Altogether, this translates into Sharpe ratio of 1.01 which is a $50 \%$ improvement over the closest competitor, PP 2 , at 0.66 . The alpha of the CP 2 is $1.84 \%$ and has a low beta to the univariate factor return of 0.15 . Adjusting the alpha by the idiosyncratic volatility of $2.04 \%$ gives an information ratio of 0.9 for CP2. A similar conclusion holds for the ME/OP25 and ME/INV25 test assets, although we observe a deterioration in the Sharpe ratio for all portfolios in larger-sized test assets possibly due to estimation errors. CP2 also underperforms PP2 in the ME/INV100 dataset.

\footnotetext{
${ }^{23}$ Note that the magnitudes of the returns for all portfolios appear to be low in comparison to those published in hedge fund return indices. This is expected since the gross exposures of our portfolios are all constrained to one. In practice, one would typically apply a leverage factor greater than one in order to magnify the returns.
}

Table 3 describes the distribution of the portfolio weights of the estimated portfolios. In the FF25 column, we see that CP2 has the lowest turnover. This is interesting given that we make no effort to control the trajectory of the weights. The average sum of negative weights in the CP2 is -0.496 and the average proportional leverage in CP2 is less than 0.5 indicating a slight tilt towards long positions. The weights are CP2 appear to be the most dispersed but do but are relatively not extreme. We draw a similar conclusion for the other test assets.

It would be interesting to investigate where the performance improvement of CP 2 comes from: Is better at selecting assets that have historically performed well on average or at varying the positions in the assets dynamically? One way to discern between the two possible explanations is to decompose the portfolio returns into the following components:
$$
\begin{equation*}
\mathbb{E}\left[w_{t}^{\prime} r_{t+1}\right]=\underbrace{\mathbb{E}\left[w_{t}\right]^{\prime} \mathbb{E}\left[r_{t+1}\right]}_{\text {static }}+\underbrace{\operatorname{Cov}\left(r_{t+1}, w_{t}\right)}_{\text {dynamic }} \tag{40}
\end{equation*}
$$

Intuitively, static bets refer to the investor's ability to get the long-run allocations right. On the other hand, the covariance between the signal and subsequent returns refers to an investor's ability to tactically 'time' the market, this is, to accurately identify movements in the assets and gain exposure to those assets accordingly.

Table 4 reports the results of this decomposition, where we estimate the static and dynamic components of returns according to Equation (40) with their corresponding sample analogs. Panels A and B show that both the static and dynamic components contribute positively to the overall performance of the portfolio. Panel C of Table 4 breaks down the share of total returns due to taking dynamic bets for CP 2 and P 2 . It shows that on average the returns of CP 2 and PP 2 come from taking dynamic bets. Therefore, the performance of our proposed method does not come from its ability to long (short) more highly performing (underperforming) assets; it must emanate from its ability to tactically time the market.

Finally, we also isolate the portfolio returns due to the long and short legs of the trade. We write $r_{t}^{w}=l\left(\left(r_{t}^{w}\right)_{+}-\left(r_{t}^{w}\right)_{-}\right)$where $\left(r_{t}^{w}\right)_{+}$is the return on the long leg and $\left(r_{t}^{w}\right)_{-}$is the return on the short leg, with weights of both trade legs normalized to sum to one. Here, $l$ denotes the leverage of the long-short portfolio, but since our estimated portfolios have a unit gross exposure by construction, $l$ is close to one. Panel D and E of Table 4 present the statistics of the long and short legs, respectively. For CP2, the average return on the long leg is $8.01 \%$ and the short leg is $5.71 \%$. This indicates that the profits of our portfolio come from the long side of the trades.

\subsection*{4.7 Robustness Checks}

In this section, we inspect whether the outperformance of our proposed portfolio construction methodology is robust to different revisions in the current empirical set-up. In particular, we will be interested in results based on (1) subsample period, (2) forecast horizon (3) shrinkage in the signal covariance, (4) momentum lookback window, and (5) 'approximate' versus 'actual' portfolio policy.

\subsection*{4.7.1 Sub-Period Analysis}

In this section, we check if there are any peculiar subsample effects that may drive the performances of our proposed scheme. We divide the out-of-sample period into four roughly equally-sized subsamples
of 144 months (that is, 12 trading years) each: (1) 1986-09-25 to 1986, (2) 1986 to 1998, (3) 1998 to 2010, and (4) 2010 to 2022. Then we perform the same procedure in each subsample. The results are provided in Table 5.

Generally, the performance of all portfolios appears stronger in the earlier periods of the sample but poorer in the recent decade. We see that the outperformance of CP 2 over the competing portfolios is consistent over time for FF25 and ME/INV25. However, CP2 underperforms PP2 in (1) ME/INV100 for most of the subsamples, and (2) FF100, ME/OP25, and ME/OP100 in the earlier subsample.

\subsection*{4.7.2 Forecast Horizon}

To make a forecast of subsequent returns, we have used a horizon length of 21 trading days, which roughly corresponds to one month. Given our use of non-overlapping observations between the signals and subsequent returns, this implies that the data are sampled on a monthly basis. which also corresponds to the frequency with which we rebalance our portfolios. We now change the forecast horizon from 21 days to 1,5 , and 10 days. Each of these forecast horizons covers an investment period from (1) 01-06-1965 to 10-21-2022, (2) 12-06-1966 to 10-21-2022, and (3) 06-12-1969 to 10-21-2022; this provides us with 14,550 daily, 2,814 weekly, and 1,347 fortnightly out-of-sample returns, respectively.

Table 6 shows that the annualized Sharpe ratio of all portfolios tends to be better at shorter holding periods. Barring the potential side effects of illiquidity in daily returns, this suggests that the conditioning information becomes more relevant as the holding period decreases. This makes sense since the conditional portfolios become more reactive to changes in the states of the market. Overall, the ranking of the methods remains similar relative to Table 2 with the exception of the 1-day horizon, where CP 2 is the best performer for all test assets.

\subsection*{4.7.3 Shrinkage Intensity}

We examine the effect of shrinkage on the covariance of signals in our proposed method. Our default choice in the analysis was $\delta_{x}=0.9$. The annualized Sharpe ratios for CP2 corresponding to shrinkage values of $\delta_{x} \in\{0,0.1,0.5,0.8,1\}$ are presented in Table 7 over different subsamples.

We see that there is no specific level of shrinkage that provides consistent outperformance for all test assets. This indicates that the shrinkage intensity $\delta_{x}$ is time-varying in nature. Shrinkage values greater than or equal to 0.5 appears to work well across different subsamples for larger-sized equity portfolios up until the recent decade, where there is some benefit of using more sample information from the signal correlations in datasets ME/OP100 and ME/INV100.

\subsection*{4.7.4 Momentum Lookback Window}

The 21-day momentum signal that we used as a base case is perceived to be a relatively 'fast' signal, reacting quickly to changes in market conditions. We now consider using momentum signals
computed with a longer lookback window of sizes 42 days, 63 days, 84 days, 126 days, and 252 days. The remaining details remain similar.

Table 8 demonstrates that CP2 generally outperforms the other portfolios in terms of annualized Sharpe ratio for different momentum signals and different test assets. Although we observe some performance degradation for all portfolios as we increase the lookback size from 21 days to 126 days, the ranking of the methods remains similar to Table 2. There is, however, a significant performance gain in CP2 not seen in the other portfolios as we extend the momentum lookback size from 126 days to 252 days. This is comforting since momentum signals with longer lookback horizons tend to have lower turnover.

\subsection*{4.7.5 Approximate Versus Actual Solution}

We have worked with the 'approximated' mean-variance problem from Proposition 2 throughout this paper since it helped us to simplify the analysis. Given that we also have a closed-form expression to the 'full' mean-variance problem from Theorem 2 in Proposition 1, we now check if it offers any practical benefits over our approximate solution. The only difference between both solutions is in terms of how the canonical correlations enter into the reconstruction of the optimal portfolio policy. The full solution essentially applies a nonlinear adjustment to the canonical correlations, while no adjustment takes place in the approximated solution. Figure 2 shows that both solutions are similar for small canonical correlation values but for large canonical correlation values, the conservative behavior of the optimal strategy is reinforced by downweighting its influence. This makes sense because we are taking into account more terms that affect the risk profile of the strategy.

From Table 9, we see that our approximated formula generally performs better than the full formula across different test assets. One reason for this observation is that the nonlinear adjustment of the canonical correlations may be too conservative relative to the unadjusted one. For example, a canonical correlation value of one gets reduced by half through the nonlinear adjustment. This holds mechanically irrespective of the data. Consequently, this behavior may inadvertently under-leverage the leading two canonical portfolios, which are the most profitable streams.

\subsection*{4.8 Extension: Two-Signal Case}

Our canonical portfolios modeling framework is flexible enough to accommodate multiple signals. In this empirical exercise, we expand our signal vector to include two momentum signals of different lookback windows; one with a 21-day lookback window, and another with a 252 -days lookback window. This expanded $2 N$-dimensional signal vector will serve as input for both CP and PP . On the other hand, we assume that both MVO and UNI take in an equal-weighted average of the two momentum signals as inputs since these methods do not have an 'optimal' way of blending different signals together in a single stage. The rest of the empirical setup remains unchanged.

From Table 10, we see that the Sharpe ratio of all portfolios, with the exception of MVO, generally improves in comparison to the one signal case. More importantly, the outperformance of CP2 over competing methods continues to hold up for different test assets.

Turning our attention to Table 11, we see that the turnover is reduced for all portfolios compared to the base case. This observation can be attributed to the inclusion of the signal with a long lookback window, which tends to have a lower turnover than one with a short lookback window. This is appealing since we can expect the performance after factoring in transaction costs to be better than using a single conditioning variable. We also observe lower proportional leverage throughout the portfolios indicating a tilt toward long positions. The weights also appear to be less dispersed than in the base case.

\section*{5 Conclusion}

In this paper, we provide a novel framework for portfolio managers and academics to conceptualize the optimal asset and signal combination problem with canonical correlation analysis (CCA). Our contribution can be summarized as follows. First, we recast the original investment problem of Brandt and Santa-Clara (2006) into a tractable one that allows us to derive an optimal portfolio policy that is applicable to large cross-sectional financial applications. Our portfolio policy is able to ingest multiple return-predictive signals, and account for cross-predictability and correlations in both the returns and signals. All of these properties are achieved by solving the portfolio selection problem in a single stage. Second, we attempted to lift the veil of complexity from our large-dimensional investment problem through a novel application of CCA. In particular, CCA breaks down the correlations of all of the asset returns and signals into independent long-short managed portfolios, which we term as canonical portfolios. Each of the canonical portfolios can be ranked from the one with the smallest correlation to the one with the highest; the canonical portfolios with the highest predictable returns get scaled up the most.

Having established the theoretical contents of our method, we bring it to the empirical test. We ran backtest simulations on Fama-French equity sorted portfolios with a momentum signal. Our findings indicate that our proposed method consistently outperforms natural benchmarks. The performance of our method further improves when the analysis is extended to two momentum signals of different lookback windows. These results are made possible by introducing regularization techniques to overcome estimation errors and exploiting the most predictable dimensions of the data.

In terms of future work, our proposed modeling framework is not set in stone and is flexible enough to accommodate further improvements. There are several potential avenues for research, such as incorporating nonlinearities or regime-switching into the modeling process. Another interesting avenue to explore would be to apply these ideas to develop a test for asset pricing models or to form portfolios on different asset classes such as individual stocks portfolios, fixed-income portfolios, currency portfolios, and so forth. Furthermore, extending the framework to incorporate transaction costs will be pursued in subsequent work. Last but not least, recasting the portfolio selection problem into a CCA framework enables researchers to leverage the insights and techniques from the rich literature of CCA that has been expanded by developments in machine learning.


\section*{B Proofs for all the Propositions}

Proof of Proposition 1. We provide the proof of this proposition in two parts.
Part 1. We drop the time subscript $t$ for brevity. From the cyclic property of the trace operator and linearity of the expectation, the expected value of the portfolio returns is
$$
\begin{equation*}
\mathbb{E}\left[x^{\prime} A r\right]=\mathbb{E}\left[\operatorname{Tr}\left(A r x^{\prime}\right)\right]=\operatorname{Tr}\left(A \Sigma_{r x}\right) \tag{B.1}
\end{equation*}
$$

In order to analyze the variance of the portfolio returns, we appeal to the following one-dimensional from Isserlis (1918) or Wick (1950), which expresses the higher moments of centered multivariate Gaussian vectors in terms of its second-moments.

Theorem 1. Let $z_{1}, z_{2}, z_{3}$, and $z_{4}$ be jointly Gaussian random variables with mean zero. Then we have the following results:
$$
\begin{align*}
\mathbb{E}\left[z_{1}\right] & =0 \\
\mathbb{E}\left[z_{1} z_{2}\right] & =\operatorname{Cov}\left(z_{1}, z_{2}\right)  \tag{B.2}\\
\mathbb{E}\left[z_{1} z_{2} z_{3}\right] & =0 \\
\mathbb{E}\left[z_{1} z_{2} z_{3} z_{4}\right] & =\mathbb{E}\left[z_{1} z_{2}\right] \mathbb{E}\left[z_{3} z_{4}\right]+\mathbb{E}\left[z_{1} z_{3}\right] \mathbb{E}\left[z_{2} z_{4}\right]+\mathbb{E}\left[z_{1} z_{4}\right] \mathbb{E}\left[z_{2} z_{3}\right]
\end{align*}
$$

The last equation of (B.2) takes all partitions of size two of the four variables, which gives us three separate terms. By recasting fourth-order terms using the covariance terms, we can express the variance as
$$
\begin{align*}
\operatorname{Var}\left[x^{\prime} A r\right]= & \mathbb{E}\left[\left(x^{\prime} A r\right)^{2}\right]-\mathbb{E}\left[x^{\prime} A r\right]^{2} \\
= & \sum_{i, j, k, l} \mathbb{E}\left[A_{i, j} A_{k, l} x_{i} r_{j} x_{k} r_{l}\right]-\sum_{i, j, k, l} \mathbb{E}\left[A_{i, j} x_{i} r_{j}\right] \mathbb{E}\left[A_{k, l} x_{k} r_{l}\right] \\
= & \sum_{i, j, k, l} A_{i, j} A_{k, l} \mathbb{E}\left[x_{i} r_{j}\right] \mathbb{E}\left[x_{k} r_{l}\right]+\sum_{i, j, k, l} A_{i, j} A_{k, l} \mathbb{E}\left[x_{i} x_{k}\right] \mathbb{E}\left[r_{j} r_{l}\right] \\
& +\sum_{i, j, k, l} A_{i, j} A_{k, l} \mathbb{E}\left[x_{i} r_{l}\right] \mathbb{E}\left[x_{k} r_{j}\right]-\sum_{i, j, k, l} A_{i, j} A_{k, l} \mathbb{E}\left[x_{i} r_{j}\right] \mathbb{E}\left[x_{k} r_{l}\right]  \tag{B.3}\\
= & \sum_{i, j, k, l} A_{i, j} A_{k, l} \mathbb{E}\left[x_{i} x_{k}\right] \mathbb{E}\left[r_{j} r_{l}\right]+\sum_{i, j, k, l} A_{i, j} A_{k, l} \mathbb{E}\left[x_{i} r_{l}\right] \mathbb{E}\left[x_{k} r_{j}\right] \\
= & \sum_{i, j, k, l} \mathbb{E}\left[x_{k} x_{i}\right] A_{i, j} \mathbb{E}\left[r_{j} r_{l}\right] A_{k, l}+\sum_{i, j, k, l} \mathbb{E}\left[r_{l} x_{i}\right] A_{i, j} \mathbb{E}\left[r_{j} x_{k}\right] A_{k, l}
\end{align*}
$$
where $A_{i, j}$ is the $(i, j)$-th entry of $A$. Reverting back to matrix notation, we have
$$
\begin{equation*}
\operatorname{Var}\left[x^{\prime} A r\right]=\operatorname{Tr}\left(\Sigma_{x} A \Sigma_{r} A^{\prime}\right)+\operatorname{Tr}\left(\Sigma_{r x} A \Sigma_{r x} A\right) \tag{B.4}
\end{equation*}
$$

Part 2. In order to solve the full mean-variance objective function (4), we use the tools from CCA that we have laid the ground in Section 3.1. To assist in our derivation, we expand our
notation and let $Q_{r}$ and $Q_{x}$ be matrices whose columns contain the so-called $i$ th canonical directions $q_{r, i}:=\Sigma_{r}^{-1 / 2} u_{i}$ and $q_{x, i}:=\Sigma_{x}^{-1 / 2} v_{i}$, respectively, and $D:=\operatorname{Diag}\left(s_{1}, s_{2}, \ldots, s_{N}\right)$ be a diagonal matrix containing the canonical correlations. We now state the main theorem:

Theorem 2. Suppose $r_{t+1}$ and $x_{t}$ are $N$-dimensional jointly Gaussian random variables. Then the objective function (2) is maximized at
$$
\begin{equation*}
A=Q_{x} \operatorname{Diag}\left(L_{1}, \ldots, L_{N}\right) Q_{r}^{\prime} \tag{B.5}
\end{equation*}
$$
where the diagonal matrix consists of the following elements
$$
\begin{equation*}
L_{i}=\frac{1}{\gamma} \frac{s_{i}}{1+s_{i}^{2}} \tag{B.6}
\end{equation*}
$$
for $i=1, \ldots, N$.
Without loss of generality, let us reparameterize the matrix of coefficients in terms of the canonical directions as $A=Q_{x} L Q_{r}^{\prime}$ where $L$ is a variable matrix that we now have to optimize on. The expected value of the portfolio returns at time $t$ can be written as
$$
\begin{align*}
\mathbb{E}\left[x_{t}^{\prime} A r_{t+1}\right] & =\operatorname{Tr}\left(A \Sigma_{r x}\right)  \tag{B.7}\\
& =\operatorname{Tr}(L D) \tag{B.8}
\end{align*}
$$
and the variance as
$$
\begin{align*}
\operatorname{Var}\left[x_{t}^{\prime} A r_{t+1}\right] & =\operatorname{Tr}\left(\Sigma_{x} A \Sigma_{r} A^{\prime}\right)+\operatorname{Tr}\left(\Sigma_{r x} A \Sigma_{r x} A\right)  \tag{B.9}\\
& =\operatorname{Tr}\left(L L^{\prime}\right)+\operatorname{Tr}(D L D L) \tag{B.10}
\end{align*}
$$

Putting all together, the objective function (4) can be written as:
$$
\begin{equation*}
\max _{L} \operatorname{Tr}(L D)-\frac{\gamma}{2}\left(\operatorname{Tr}\left(L L^{\prime}\right)-\operatorname{Tr}(D L D L)\right) \tag{B.11}
\end{equation*}
$$

Using the rules for matrix derivatives from Ltkepohl (1997), we take first-order conditions with respect to the matrix $L$ to get
$$
\begin{equation*}
D-\gamma\left(L+D L^{\prime} D\right)=0 \tag{B.12}
\end{equation*}
$$

Since the matrix $D$ is diagonal and thus symmetric, we necessarily have the following relationship
$$
\begin{equation*}
\frac{1}{\gamma} D=L+D L^{\prime} D=L^{\prime}+D L D \tag{B.13}
\end{equation*}
$$

Let $L^{a}:=L-L^{\prime}$, which is an anti-symmetric matrix (that is, $L^{a^{\prime}}=-L^{a}$ ) and has diagonal elements
zero. Then we have
$$
\begin{equation*}
L^{a}=D L^{a} D \tag{B.14}
\end{equation*}
$$

If we restrict our attention to the off-diagonal elements of (B.14), we see that $L_{i, j}^{A}=s_{i} s_{j} L_{i, j}^{A}$ for all $i \neq j$, so $\left(1-s_{i} s_{j}\right) L_{i, j}^{A}=0$. Therefore, either $s_{i} s_{j}=1$ for all $i \neq j$ or $L_{i, j}^{A}=0$. Consequently, $L^{a}$ is identically zero and hence, $L$ must be a symmetric matrix.

The benefit of variable matrix $L$ being symmetric is that the condition (B.12) can now be written as
$$
\begin{equation*}
L+D L D=\frac{1}{\gamma} D \tag{B.15}
\end{equation*}
$$

If we focus on off-diagonal elements, we see that $\left(1+s_{i} s_{j}\right) L_{i, j}=0$ for all $i \neq j$. But we also know that the canonical correlations satisfy the following ordering $0 \leq s_{1} \leq \ldots \leq s_{N} \leq 1$, and so it is impossible that $s_{i} s_{j}=-1$. Thus, $L_{i, j}=0$ for all $i \neq j$, and so $L$ must be a diagonal matrix. Thus, optimizing over the elements $L_{i i} \equiv L_{i}$ for $i=1, \ldots, N$, boils down to maximizing the following univariate problems
$$
\begin{equation*}
\max _{L_{1}, \ldots, L_{N}} \sum_{i=1}^{N} L_{i} s_{i}-\frac{\gamma}{2}\left(L_{i}^{2}+s_{i}^{2} L_{i}^{2}\right) \tag{B.16}
\end{equation*}
$$

Our problem can now be easily solved to give us
$$
\begin{equation*}
L_{i}=\frac{1}{\gamma} \frac{s_{i}}{1+s_{i}^{2}} \tag{B.17}
\end{equation*}
$$

Hence, the diagonal elements are a nonlinear function of the canonical correlations. The optimal matrix $A$ in (B.5) is effectively the optimal scaling of the canonical portfolios of the asset returns and signals.

Proof of Proposition 2. Applying a change-of-variables $\tilde{A}:=\Sigma_{x}^{1 / 2} A \Sigma_{r}^{1 / 2}$, we have
$$
\begin{equation*}
\max _{\tilde{A}} \operatorname{Tr}\left(\tilde{A} \Sigma_{\tilde{r} \tilde{x}}^{\prime}\right)-\frac{\gamma}{2} \operatorname{Tr}\left(\tilde{A} \tilde{A}^{\prime}\right) \tag{B.18}
\end{equation*}
$$

The problem (B.18) can be solved to yield
$$
\begin{equation*}
\tilde{A}=\frac{1}{\gamma} \Sigma_{x}^{-1 / 2} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1 / 2} \tag{B.19}
\end{equation*}
$$

Since the solution is expressed in a different basis, we rescale it back to the original assets through the following operation
$$
\begin{equation*}
A=\Sigma_{x}^{-1 / 2} \tilde{A} \Sigma_{r}^{-1 / 2}=\frac{1}{\gamma} \Sigma_{x}^{-1} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1} \tag{B.20}
\end{equation*}
$$

As a result of this approximation, we now have
$$
\begin{equation*}
L_{i} \approx \frac{1}{\gamma} s_{i} \tag{B.21}
\end{equation*}
$$

Figure 2 contrasts the optimal singular value adjustment in (B.6) to the linear approximation (B.21) for $\gamma=1$. We can see that for small values of $s_{i}$, the optimal adjustment is approximately linear while for large values of $s_{i}$, the optimal adjustment downweighs the value of the canonical correlation.

Proof of Proposition 3. We start by writing down the expression for the Lagrangian
$$
\begin{equation*}
\operatorname{Tr}\left(A \Sigma_{r x}\right)-\frac{\gamma}{2} \operatorname{Tr}\left(\Sigma_{x} A \Sigma_{r} A^{\prime}\right)+\lambda\left(1-\mathbf{1}^{\prime} A^{\prime} x_{t}\right) \tag{B.22}
\end{equation*}
$$
$\lambda>0$ is the Lagrange multiplier. Using the change-of-variables $\tilde{A}:=\Sigma_{x}^{1 / 2} A \Sigma_{r}^{1 / 2}$, we have
$$
\begin{equation*}
\operatorname{Tr}\left(\tilde{A} \Sigma_{\tilde{r} \tilde{x}}\right)-\frac{\gamma}{2} \operatorname{Tr}\left(\tilde{A} \tilde{A}^{\prime}\right)+\lambda\left(1-\mathbf{1}^{\prime} \Sigma_{r}^{-1 / 2} \tilde{A}^{\prime} \Sigma_{x}^{-1 / 2} x_{t}\right) \tag{B.23}
\end{equation*}
$$

Performing the first-order conditions
$$
\begin{align*}
& {[\operatorname{FOC} \tilde{A}]: \Sigma_{\tilde{r} \tilde{x}}^{\prime}-\gamma \tilde{A}-\lambda \Sigma_{x}^{-1 / 2} x_{t} \mathbf{1}^{\prime} \Sigma_{r}^{-1 / 2}=0}  \tag{B.24}\\
& {[\operatorname{FOC} \lambda]: 1-\mathbf{1}^{\prime} w_{t}=0} \tag{B.25}
\end{align*}
$$

By reverting the change-of-variables we have made and using the fact that the portfolio policies are linear the signals, the portfolio weights is then
$$
\begin{equation*}
w_{t}^{\mathrm{FI}}=\frac{1}{\gamma} \Sigma_{r}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} x_{t}+\lambda\left(x_{t}^{\prime} \Sigma_{x}^{-1} x_{t}\right) \mathbf{1}^{\prime} \Sigma_{r}^{-1} \tag{B.26}
\end{equation*}
$$

Solving for $\lambda$ gives
$$
\begin{equation*}
\lambda=\frac{1-\kappa}{\left(x_{t}^{\prime} \Sigma_{x}^{-1} x_{t}\right)\left(\mathbf{1}^{\prime} \Sigma_{r}^{-1} \mathbf{1}\right)} \tag{B.27}
\end{equation*}
$$
where $\kappa:=\gamma^{-1} \mathbf{1}^{\prime} \Sigma_{r}^{-1} \Sigma_{r x} \Sigma_{x}^{-1} x_{t}$. Inserting the $\lambda$ into (B.26) and rearranging the expression gives us the optimal portfolio (18).

Proof of Proposition 4. If $r_{t+1}$ and $x_{t}$ are $N$-dimensional zero-mean Gaussian random variables, then their projections onto the $i$ th canonical portfolios given by $u_{i}^{\prime} \tilde{r}_{t+1}$ and $v_{i}^{\prime} \tilde{x}_{t}$ are also Gaussian random variables with mean zero and unit variances and a joint correlation $s_{i}$. For the expected return of the $i$ th canonical portfolio, we have
$$
\begin{equation*}
\mathbb{E}\left[\pi_{t, i}\right]=s_{i} v_{i}^{\prime} \Sigma_{\tilde{r} \tilde{x}}^{\prime} u_{i}=s_{i}^{2} \tag{B.28}
\end{equation*}
$$

Furthermore, the variance of the $i$ th canonical portfolio is
$$
\begin{align*}
\operatorname{Var}\left[\pi_{t, i}\right] & =\mathbb{E}\left[s_{i}^{2}\left(v_{i}^{\prime} \tilde{x}_{t}\right)^{2}\left(u_{i}^{\prime} \tilde{r}_{t+1}\right)^{2}\right]-s_{i}^{4}  \tag{B.29}\\
& =s_{i}^{2}\left(1+2 s_{i}^{2}\right)-s_{i}^{4}  \tag{B.30}\\
& =s_{i}^{2}\left(1+s_{i}^{2}\right) \tag{B.31}
\end{align*}
$$

The second equality follows from the second-moment-based result of the product of two correlated Gaussian variables from Haldane (1942, Section 6). Substituting the expression of the optimal policy $A$ into the definition of the expected value and variance of the portfolio returns, we have:
$$
\begin{align*}
& \mathbb{E}\left[x_{t}^{\prime} A r_{t+1}\right]=\frac{1}{\gamma} \operatorname{Tr}\left(\Sigma_{x}^{-1} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1} \Sigma_{r x}\right)=\frac{1}{\gamma} \sum_{i=1}^{N} s_{i}^{2}  \tag{B.32}\\
& \mathbb{E}\left[x_{t}^{\prime} A \Sigma_{r} A^{\prime} x_{t}\right]=\frac{1}{\gamma^{2}} \operatorname{Tr}\left(\Sigma_{x}^{-1} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1} \Sigma_{r x}\right)=\frac{1}{\gamma^{2}} \sum_{i=1}^{N} s_{i}^{2} . \tag{B.33}
\end{align*}
$$

The proof concludes.
Proof of Corollary 1. This follows immediately Proposition 4 and the definition of the Sharpe ratio.

Proof of Proposition 5. Substituting the second-moment matrix of managed portfolio returns (37) into the policy matrix $A$ from (6), the expected returns based on this matrix of coefficients is then
$$
\begin{equation*}
\mathbb{E}\left[x_{t}^{\prime} A r_{t+1}\right]=\frac{1}{\gamma} \operatorname{Tr}\left(\Sigma_{x}^{-1} \Sigma_{r x}^{\prime} \Sigma_{r}^{-1} \Sigma_{r x}\right)=\frac{1}{\gamma}\left(\mu_{r}^{\prime} \Sigma_{r}^{-1} \mu_{r}\right)\left(\mu_{x}^{\prime} \Sigma_{x}^{-1} \mu_{x}\right)+\frac{1}{\gamma} \sum_{i=1}^{N} s_{i}^{2} \tag{B.34}
\end{equation*}
$$
and the claim follows.

import numpy as np
import pandas as pd
from sklearn.base import BaseEstimator, RegressorMixin
from sklearn.utils.validation import check_is_fitted

class CanonicalPortfolio(BaseEstimator, RegressorMixin):
    """
    A scikit-learn compatible estimator for a linear predictive strategy
    based on Canonical Portfolios, accepting both NumPy arrays and pandas DataFrames.

    Parameters
    ----------
    top_k : int or None, default=None
        The number of canonical portfolios to use for the main `predict` method.
        If None, all are used.
    """
    def __init__(self, top_k=None):
        self.top_k = top_k
        self.U_ = None
        self.VT_ = None
        self.Sigma_rr_inv_sqrt_ = None
        self.Sigma_zz_inv_sqrt_ = None
        self.n_features_in_ = None

    def _validate_data(self, X, y=None):
        """Internal helper to convert pandas DataFrames to NumPy arrays."""
        if isinstance(X, pd.DataFrame):
            X = X.to_numpy()
        if y is not None and isinstance(y, pd.DataFrame):
            y = y.to_numpy()
        return X, y

    def fit(self, X, y):
        """
        Estimates the covariance matrices and computes the SVD of the
        whitened cross-covariance matrix.

        Parameters
        ----------
        X : np.ndarray or pd.DataFrame of shape (T, M)
            Historical signals, with T time steps and M signals.
        y : np.ndarray or pd.DataFrame of shape (T, N)
            Corresponding historical returns.

        Returns
        -------
        self : object
            Returns the instance itself.
        """
        S, R = self._validate_data(X, y)

        T, M = S.shape
        T, N = R.shape

        self.n_features_in_ = M
        self.n_returns_ = N

        # 1. Estimate covariance matrices
        Sigma_rr = (R.T @ R) / T
        Sigma_zz = (S.T @ S) / T
        Sigma_rz = (R.T @ S) / T

        # 2. Whiten the data
        Sigma_rr_inv_sqrt = np.linalg.pinv(np.linalg.cholesky(Sigma_rr))
        Sigma_zz_inv_sqrt = np.linalg.pinv(np.linalg.cholesky(Sigma_zz))
        
        self.Sigma_rr_inv_sqrt_ = Sigma_rr_inv_sqrt
        self.Sigma_zz_inv_sqrt_ = Sigma_zz_inv_sqrt

        # 3. Compute the whitened cross-covariance matrix
        whitened_Sigma_rz = Sigma_rr_inv_sqrt @ Sigma_rz @ Sigma_zz_inv_sqrt.T

        # 4. Perform SVD
        self.U_, self.Lambdas_, self.VT_ = np.linalg.svd(whitened_Sigma_rz)
        
        self._k = self.top_k if self.top_k is not None else min(N, M)
        if not (1 <= self._k <= min(N, M)):
            raise ValueError(f"top_k must be between 1 and {min(N, M)}, or None.")

        return self

    def predict(self, X):
        """
        Computes portfolio weights for a given signal vector, using the top_k canonical portfolios.

        Parameters
        ----------
        X : np.ndarray or pd.DataFrame of shape (n_samples, M)
            An array of signal vectors.

        Returns
        -------
        weights : np.ndarray of shape (n_samples, N)
            The calculated portfolio weights for each time step.
        """
        check_is_fitted(self)
        X, _ = self._validate_data(X)

        n_samples, n_features = X.shape
        if n_features != self.n_features_in_:
            raise ValueError(f"Number of features in X ({n_features}) does not match "
                             f"the number of features from training ({self.n_features_in_}).")

        # Reconstruct the optimal B matrix using top_k components
        U_k = self.U_[:, :self._k]
        Lambdas_k = np.diag(self.Lambdas_[:self._k])
        VT_k = self.VT_[:self._k, :]
        
        # B_star = Sigma_rr_inv_sqrt @ U @ Lambda @ V^T @ Sigma_zz_inv_sqrt
        B_star_k = self.Sigma_rr_inv_sqrt_ @ U_k @ Lambdas_k @ VT_k @ self.Sigma_zz_inv_sqrt_.T

        # Calculate weights: w = B_star * z
        weights = X @ B_star_k.T
        
        # The canonical approach doesn't have a natural scaling without gamma.
        # Here we apply the same normalization as in the PrincipalPortfolio class
        # for a fair comparison, although it is not part of the core derivation.
        norm_factor = np.sum(np.abs(weights), axis=1, keepdims=True)
        weights /= norm_factor
        
        return weights

    def predict_k(self, X, k):
        """
        Computes portfolio weights for a specific canonical portfolio.
        
        This method will return the weights for the k-th canonical portfolio,
        scaled by the k-th canonical correlation.
        
        Parameters
        ----------
        X : np.ndarray or pd.DataFrame of shape (n_samples, M)
            An array of signal vectors.
        k : int
            The index of the canonical portfolio to use (1-indexed).

        Returns
        -------
        weights : np.ndarray of shape (n_samples, N)
            The calculated portfolio weights for the k-th canonical portfolio.
        """
        check_is_fitted(self)
        X, _ = self._validate_data(X)
        
        if not (1 <= k <= min(self.n_returns_, self.n_features_in_)):
            raise ValueError(f"k must be a valid index between 1 and {min(self.n_returns_, self.n_features_in_)}.")
        k_idx = k - 1
        
        # Extract the k-th canonical components
        u_k = self.U_[:, k_idx].reshape(-1, 1)
        lambda_k = self.Lambdas_[k_idx]
        v_k_t = self.VT_[k_idx, :].reshape(1, -1)
        
        # Reconstruct the k-th component of B_star
        # B_k = Sigma_rr_inv_sqrt @ u_k @ lambda_k @ v_k^T @ Sigma_zz_inv_sqrt
        B_k = self.Sigma_rr_inv_sqrt_ @ u_k * lambda_k * v_k_t @ self.Sigma_zz_inv_sqrt_.T

        # Calculate weights: w = B_k * z
        weights = X @ B_k.T

        # Normalize the weights
        norm_factor = np.sum(np.abs(weights), axis=1, keepdims=True)
        weights /= norm_factor

        return weights

